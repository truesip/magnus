<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f8fafc;color:#0f172a;min-height:100vh;display:flex;flex-direction:column}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#4f46e5;border-bottom:1px solid #4338ca;color:#fff}
    .brand{font-weight:700}
    .header-right{display:flex;align-items:center;gap:12px;font-size:14px}
    .header-balance{font-size:14px;color:#e5e7eb}
    #noticeable-widget{display:flex;align-items:center}
    .wrap{display:flex;height:calc(100vh - 54px)}
    aside{width:220px;border-right:1px solid #e5e7eb;background:#ffffff}
    aside a{display:flex;align-items:center;gap:10px;padding:14px 18px;color:#1f2937;text-decoration:none;border-bottom:1px solid #e5e7eb;transition:all 0.2s}
    aside a:hover{background:#e5e7eb;color:#111827}
    aside a.active{background:#eff6ff;color:#1e3a8a;font-weight:600}
    .nav-icon{width:18px;height:18px;flex:0 0 auto}
    .sidebar-user{padding:12px 18px;color:#6b7280;font-size:12px;border-top:1px solid #e5e7eb;background:#f9fafb}
    main{flex:1;overflow:auto;padding:16px}
    h2{margin:8px 0 12px 0}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #e5e7eb;padding:8px 6px;text-align:left;font-size:13px}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    input,select,textarea{border:1px solid #d1d5db;border-radius:8px;padding:8px 10px}
    .cid-input{max-width:140px}
    button{background:#4f46e5;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;transition:all 0.15s ease}
    button:hover{background:#4338ca}
    button:active{background:#3730a3;transform:scale(0.97)}
    button.btn-clicked{animation:btnClick 0.3s ease}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .icon-btn{background:transparent;color:#4b5563;border-radius:999px;padding:2px 6px;font-size:11px;border:none;cursor:pointer}
    .icon-btn:hover{background:#e5e7eb;color:#111827}
    .sip-pass{font-family:monospace;letter-spacing:2px}
    .sip-pass-toggle{margin-right:4px}
    .muted{color:#6b7280;font-size:12px}
    pre{background:#0b1220;color:#e2e8f0;padding:8px;border-radius:8px;overflow:auto}
    .balance-value{font-size:18px;font-weight:600;color:#059669}
    .status-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
    .status-ok{background:#10b981}
    .status-unreachable{background:#ef4444}
    .status-unknown{background:#6b7280}
    .direction-icon{color:#4f46e5;font-weight:600;font-size:16px}
    .toast{position:fixed;top:20px;right:20px;background:#10b981;color:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:9999;animation:slideIn 0.3s ease-out}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes btnClick{0%{transform:scale(1)}50%{transform:scale(0.95);background:#3730a3}100%{transform:scale(1)}}
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin:8px 0 16px 0}
    .kpi-card{background:#ffffff;border-radius:12px;padding:10px 12px;border:1px solid #e5e7eb;box-shadow:0 1px 2px rgba(15,23,42,0.05)}
    .kpi-label{font-size:12px;color:#6b7280;margin-bottom:4px}
    .kpi-value{font-size:20px;font-weight:600;color:#111827}
    .kpi-sub{font-size:11px;color:#9ca3af}
    #callsChartContainer{margin-top:8px;margin-bottom:16px;background:#ffffff;border-radius:12px;border:1px solid #e5e7eb;padding:12px}
    #callsChart{width:100%;max-height:220px}

    /* AI Agent modal (compact) */
    #aiAgentModal .ai-agent-modal-card{font-size:12px}
    #aiAgentModal .ai-agent-modal-card label{font-size:12px !important}
    #aiAgentModal .ai-agent-modal-card .muted{font-size:11px}
    #aiAgentModal .ai-agent-modal-card input,
    #aiAgentModal .ai-agent-modal-card select,
    #aiAgentModal .ai-agent-modal-card textarea{padding:6px 8px;border-radius:6px;font-size:12px}
    #aiAgentModal .ai-agent-modal-card button{padding:6px 10px;border-radius:6px;font-size:12px}

    /* AI subtabs */
    .ai-subtabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px 0}
    .ai-subtab{background:#e5e7eb !important;color:#111827 !important;border:1px solid #d1d5db !important;border-radius:999px !important;padding:6px 10px !important;font-size:12px !important}
    .ai-subtab.active{background:#4f46e5 !important;color:#ffffff !important;border-color:#4338ca !important}

    /* AI Tools pane: avoid toolbar content overflowing into adjacent cards */
    #ai-pane-tools .toolbar{flex-wrap:wrap}
    #ai-pane-tools .toolbar > *{min-width:0;max-width:100%}

    /* Allow inputs inside CSS grid/flex to shrink instead of overflowing (prevents overlap) */
    #ai-pane-tools input[type="text"],
    #ai-pane-tools input[type="number"],
    #ai-pane-tools input[type="password"],
    #ai-pane-tools input[type="email"],
    #ai-pane-tools input[type="url"],
    #ai-pane-tools input[type="file"],
    #ai-pane-tools select,
    #ai-pane-tools textarea{
      min-width:0;
      max-width:100%;
      box-sizing:border-box;
    }
    #ai-pane-tools input[type="file"]{width:100%}

    /* Document templates table: prevent content from overflowing the card */
    #ai-doc-templates-table{table-layout:fixed}
    #ai-doc-templates-table th,
    #ai-doc-templates-table td{overflow-wrap:anywhere}
    #ai-doc-templates-table th:last-child,
    #ai-doc-templates-table td:last-child{white-space:nowrap;padding-right:12px;width:96px}

    /* Mobile optimizations */
    @media (max-width: 768px) {
      header{flex-wrap:wrap;align-items:flex-start;}
      .header-right{margin-top:8px;flex-wrap:wrap;justify-content:flex-start;width:100%;}
      .wrap{flex-direction:column;height:auto;min-height:calc(100vh - 54px);}
      aside{width:100%;display:flex;overflow-x:auto;border-right:none;border-bottom:1px solid #e5e7eb;}
      aside a{flex:0 0 auto;padding:10px 12px;font-size:13px;white-space:nowrap;border-bottom:none;border-right:1px solid #e5e7eb;}
      .sidebar-user{display:none;}
      main{padding:12px;height:auto;}
      .toolbar{flex-wrap:wrap;align-items:flex-start;}
      .toolbar > *{margin-bottom:4px;}
      .toolbar input,
      .toolbar select{width:100%;max-width:none;}
      table{font-size:12px;}
      #profile-table th,#profile-table td{display:block;width:100%;box-sizing:border-box;}
      #profile-table tr{border-bottom:1px solid #e5e7eb;}
    }

    @media (max-width: 480px) {
      header{padding:8px 10px;}
      .brand{font-size:16px;}
      .header-right{gap:8px;font-size:12px;}
      button{padding:6px 10px;font-size:12px;}
    }
  </style>
  <style>
    /* Small method badges for billing history */
    .bill-tag {
      display:inline-block;
      margin-right:6px;
      padding:1px 6px;
      border-radius:999px;
      font-size:10px;
      font-weight:600;
      vertical-align:middle;
    }
    .bill-tag-card {
      background:#ecfdf5;
      color:#047857;
      border:1px solid #6ee7b7;
    }
    .bill-tag-crypto {
      background:#eff6ff;
      color:#1d4ed8;
      border:1px solid #bfdbfe;
    }
    .bill-tag-billcom {
      background:#f5f3ff;
      color:#5b21b6;
      border:1px solid #ddd6fe;
    }
    /* Status badges for billing rows */
    .bill-status {
      display:inline-block;
      padding:1px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:600;
      vertical-align:middle;
    }
    .bill-status-completed {
      background:#ecfdf5;
      color:#047857;
      border:1px solid #6ee7b7;
    }
    .bill-status-pending {
      background:#fffbeb;
      color:#92400e;
      border:1px solid #fed7aa;
    }
    .bill-status-failed {
      background:#fef2f2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }
  </style>

  <!-- Noticeable widget -->
  <script>
    !function(){'use strict';const e=['debug','destroy','do','help','identify','is','off','on','ready','render','reset','safe','set'];if(window.noticeable)console.warn('Noticeable SDK code snippet loaded more than once');else{const n=window.noticeable=window.noticeable||[];function t(e){return function(){const t=Array.prototype.slice.call(arguments);return t.unshift(e),n.push(t),n}}function o(){for(let o=0;o<e.length;o++){const c=e[o];n[c]=t(c)}}function c(){const e=document.createElement('script');e.async=!0;e.src='https://sdk.noticeable.io/l.js';const n=document.head;n.insertBefore(e,n.firstChild)}o();c()}}();
  </script>
  <script>
    noticeable.render('widget', 'UjIu5kI00favBWSvBEGd');
  </script>
</head>
<body>
  <header>
    <div class="brand">TalkUSA</div>
    <div class="header-right">
      <div id="noticeable-widget"></div>
      <span id="currentBalance" class="header-balance"></span>
      <button id="addFundBtn" style="background:#059669">‚ûï Add Funds</button>
      <form style="display:inline" method="post" action="/logout"><button type="submit">Logout</button></form>
    </div>
  </header>
  <div class="wrap">
    <aside>
      <a href="#overview" id="tab-overview" class="active"><img class="nav-icon" src="/Icon/Overview.ico" alt="" aria-hidden="true"><span>Overview</span></a>
      <a href="#sip" id="tab-sip"><img class="nav-icon" src="/Icon/SIP%20Accounts.ico" alt="" aria-hidden="true"><span>SIP Account</span></a>
      <a href="#mydids" id="tab-mydids"><img class="nav-icon" src="/Icon/My%20Numbers.ico" alt="" aria-hidden="true"><span>My Numbers</span></a>
      <a href="#buydid" id="tab-buydid"><img class="nav-icon" src="/Icon/Buy%20Numbers.ico" alt="" aria-hidden="true"><span>Buy Numbers</span></a>
      <a href="#ai" id="tab-ai"><img class="nav-icon" src="/Icon/AI%20Agent.ico" alt="" aria-hidden="true"><span>AI Agent</span></a>
      <a href="#trunk" id="tab-trunk"><img class="nav-icon" src="/Icon/call-forwarding.ico" alt="" aria-hidden="true"><span>Call Forwarding</span></a>
      <a href="#cdr" id="tab-cdr"><img class="nav-icon" src="/Icon/Call%20History.ico" alt="" aria-hidden="true"><span>Call History</span></a>
      <a href="#billing" id="tab-billing"><img class="nav-icon" src="/Icon/Billing%20History.ico" alt="" aria-hidden="true"><span>Billing History</span></a>
      <a href="#profile" id="tab-profile"><img class="nav-icon" src="/Icon/Profile.ico" alt="" aria-hidden="true"><span>Profile</span></a>
      <div class="sidebar-user">Signed in as <strong><%= username %></strong></div>
    </aside>
    <main>
      <section id="view-overview">
        <h2>Overview</h2>
        <div id="overviewStats">
          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-label">Total DIDs</div>
              <div class="kpi-sub" id="kpiTotalDidsSub"></div>
              <div class="kpi-value" id="kpiTotalDids">‚Äì</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Inbound Calls</div>
              <div class="kpi-sub" id="kpiInboundToday"></div>
              <div class="kpi-value" id="kpiInbound">‚Äì</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Outbound Calls</div>
              <div class="kpi-sub" id="kpiOutboundToday"></div>
              <div class="kpi-value" id="kpiOutbound">‚Äì</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">SIP Accounts</div>
              <div class="kpi-sub" id="kpiSipOnline"></div>
              <div class="kpi-value" id="kpiSipTotal">‚Äì</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">AI Agent</div>
              <div class="kpi-sub"><span id="kpiAiEmailsSent">‚Äì</span> emails sent</div>
              <div class="kpi-value" id="kpiAiAgents">‚Äì</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Meeting + Mail</div>
              <div class="kpi-sub"><span id="kpiAiMeetingLinksSent">‚Äì</span> meeting links ‚Ä¢ <span id="kpiAiPhysicalMailSent">‚Äì</span> mail</div>
              <div class="kpi-value" id="kpiAiMeetingMailTotal">‚Äì</div>
            </div>
          </div>
          <div id="callsChartContainer">
            <div class="muted" id="statsRangeText" style="margin-bottom:4px;"></div>
            <canvas id="callsChart"></canvas>
          </div>
        </div>
      </section>
      <section id="view-profile" style="display:none">
        <h2>Profile</h2>
        <table id="profile-table" style="display:none"><tbody></tbody></table>
        <div class="toolbar">
          <button id="deleteAccountBtn" disabled title="Deleting the primary signup user is disabled">Delete Account</button>
        </div>
        <div id="profile-empty" class="muted">Loading‚Ä¶</div>
      </section>
      <section id="view-sip" style="display:none">
        <h2>SIP Account</h2>
        <div class="toolbar">
          <button id="createSipBtn" style="background:#4f46e5">‚ûï Create SIP Account</button>
          <input type="text" id="sipSearch" placeholder="Search by username or CallerID..." style="width:220px;margin-left:auto">
          <button id="sipSearchBtn">Search</button>
          <button id="sipClearBtn" style="background:#6b7280">Clear</button>
        </div>
        <table id="sip-table" style="display:none">
          <thead><tr><th>Status</th><th>User</th><th>Password</th><th>Domain</th><th>CallerID</th><th>Direction</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="toolbar" id="sip-pager" style="display:none">
          <button id="sipPrev">Prev</button>
          <span id="sipPageInfo" class="muted"></span>
          <button id="sipNext">Next</button>
        </div>
        <div id="sip-empty" class="muted">Loading‚Ä¶</div>
      </section>
      <section id="view-cdr" style="display:none">
        <h2>Call History</h2>
        <div class="toolbar">
          <label>From <input type="date" id="from"></label>
          <label>To <input type="date" id="to"></label>
          <label>DID
            <select id="cdrDid">
              <option value="">All My Numbers</option>
            </select>
          </label>
          <select id="cdrFilter" style="margin-left:10px">
            <option value="all">All Calls</option>
            <option value="inbound">Inbound Only</option>
            <option value="outbound">Outbound Only</option>
          </select>
          <button id="loadCdr">Load</button>
        </div>
        <table id="cdr-table" style="display:none">
          <thead><tr><th>Direction</th><th>Date/Time</th><th>From</th><th>To</th><th>Duration</th><th>Cost</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="toolbar" id="cdr-pager" style="display:none">
          <button id="cdrPrev">Prev</button>
          <span id="cdrPageInfo" class="muted"></span>
          <button id="cdrNext">Next</button>
        </div>
        <div id="cdr-empty" class="muted">Loading‚Ä¶</div>
      </section>
      <section id="view-trunk" style="display:none">
        <h2>Call Forwarding</h2>
        <div class="toolbar">
          <button id="createTrunkBtn" style="background:#f59e0b">‚ûï Create Trunk</button>
          <input type="text" id="trunkSearch" placeholder="Search by name or destination..." style="width:220px;margin-left:auto">
          <button id="trunkSearchBtn">Search</button>
          <button id="trunkClearBtn" style="background:#6b7280">Clear</button>
        </div>
        <table id="trunk-table" style="display:none">
          <thead><tr><th>Name</th><th>PSTN Destination</th><th>Description</th><th>Capacity</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="toolbar" id="trunk-pager" style="display:none">
          <button id="trunkPrev">Prev</button>
          <span id="trunkPageInfo" class="muted"></span>
          <button id="trunkNext">Next</button>
        </div>
        <div id="trunk-empty" class="muted">Loading‚Ä¶</div>
      </section>
      <section id="view-buydid" style="display:none">
        <h2>Buy Numbers</h2>
        <div class="toolbar">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
            <input type="checkbox" id="buyTollfree"> <span>üÜì Toll-Free</span>
          </label>
          <select id="buyCountry"><option value="">Select Country...</option></select>
          <select id="buyRegion" disabled><option value="">Select State/Region...</option></select>
          <select id="buyCity" disabled><option value="">Select City...</option></select>
          <button id="searchDids">Search Numbers</button>
        </div>
        <div id="did-results" style="margin-top:12px">
          <div id="did-groups-info" class="muted"></div>
          <table id="available-dids-table" style="display:none">
            <thead><tr><th>Number</th><th>Type</th><th>Monthly</th><th>Setup</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
          <div id="available-dids-empty" class="muted"></div>
        </div>
      </section>
      <section id="view-mydids" style="display:none">
        <h2>My Numbers</h2>
        <div class="toolbar">
          <input type="text" id="mydidsSearch" placeholder="Search by number or location..." style="width:220px">
          <button id="mydidsSearchBtn">Search</button>
          <button id="mydidsClearBtn" style="background:#6b7280">Clear</button>
        </div>
        <table id="mydids-table" style="display:none">
<thead><tr><th>Number</th><th>Location</th><th>Status</th><th>Features</th><th>Monthly</th><th>Call Forwarding</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="toolbar" id="mydids-pager" style="display:none">
          <button id="mydidsPrev">Prev</button>
          <span id="mydidsPageInfo" class="muted"></span>
          <button id="mydidsNext">Next</button>
        </div>
        <div id="mydids-empty" class="muted">Loading‚Ä¶</div>
      </section>

      <section id="view-ai" style="display:none">
        <h2>AI Agent</h2>
        <div class="muted" style="margin-bottom:10px">Create AI agents for inbound calls and video meetings ‚Äî assign numbers, send meeting links, review conversations, and configure tools like email and call transfer.</div>

        <div class="ai-subtabs">
          <button id="ai-subtab-agents" type="button" class="ai-subtab active">Agents</button>
          <button id="ai-subtab-conversations" type="button" class="ai-subtab">Conversations</button>
          <button id="ai-subtab-emails" type="button" class="ai-subtab">Emails</button>
          <button id="ai-subtab-meetings" type="button" class="ai-subtab">Meeting</button>
          <button id="ai-subtab-mail" type="button" class="ai-subtab">Mail</button>
          <button id="ai-subtab-tools" type="button" class="ai-subtab">Tools</button>
        </div>

        <div id="ai-pane-agents">
          <div style="display:flex;gap:16px;flex-wrap:wrap">
            <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                <h3 style="margin:0">Agents <span id="aiAgentsCount" class="muted"></span></h3>
                <div style="margin-left:auto"></div>
                <button id="createAiAgentBtn" style="background:#4f46e5">‚ûï Create Agent</button>
              </div>
              <table id="ai-agents-table" style="display:none">
                <thead><tr><th>Name</th><th>Voice</th><th>Greeting</th><th>Number</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
              <div id="ai-agents-empty" class="muted">Loading‚Ä¶</div>
            </div>

            <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                <h3 style="margin:0">Phone Numbers <span id="aiNumbersCount" class="muted"></span></h3>
                <div style="margin-left:auto"></div>
                <button id="buyAiNumberBtn" style="background:#059669">‚ûï Buy Number</button>
              </div>
              <table id="ai-numbers-table" style="display:none">
                <thead><tr><th>Number</th><th>Assigned Agent</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
              <div id="ai-numbers-empty" class="muted">Loading‚Ä¶</div>
            </div>
          </div>
        </div>

        <div id="ai-pane-tools" style="display:none">
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;align-items:start">
            <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
              <h3 style="margin:0 0 10px 0">Email (SMTP)</h3>
              <div class="muted" style="margin-bottom:10px">Used when your AI agent emails documents to callers.</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <input id="smtpHost" type="text" placeholder="SMTP host (e.g. smtp.gmail.com)">
                <input id="smtpPort" type="number" placeholder="Port (e.g. 587)">
                <label style="display:flex;align-items:center;gap:6px;font-size:13px">
                  <input id="smtpSecure" type="checkbox"> Use SSL (secure)
                </label>
                <div></div>
                <input id="smtpUsername" type="text" placeholder="Username">
                <input id="smtpPassword" type="password" placeholder="Password (leave blank to keep current)">
                <input id="smtpFromEmail" type="email" placeholder="From email (e.g. you@domain.com)">
                <input id="smtpFromName" type="text" placeholder="From name (optional)">
                <input id="smtpReplyTo" type="email" placeholder="Reply-to (optional)">
                <input id="smtpTestToEmail" type="email" placeholder="Test recipient (optional)">
              </div>
              <div class="toolbar" style="margin-top:10px">
                <button id="saveSmtpBtn">Save SMTP</button>
                <button id="testSmtpBtn" style="background:#6b7280">Send Test Email</button>
                <span id="smtpStatus" class="muted" style="margin-left:auto"></span>
              </div>
            </div>

            <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
              <h3 style="margin:0 0 10px 0">Call Transfer</h3>
              <div class="muted" style="margin-bottom:10px">Default transfer destination used by agents without an override. You can set a different transfer destination per agent in the agent editor.</div>
              <div style="display:grid;grid-template-columns:1fr;gap:8px">
                <input id="aiTransferNumber" type="text" placeholder="Transfer destination (E.164 like +18005551234 or sip:agent@domain)">
              </div>
              <div class="toolbar" style="margin-top:10px">
                <button id="saveAiTransferBtn">Save Transfer</button>
                <span id="aiTransferStatus" class="muted" style="margin-left:auto"></span>
              </div>
            </div>

            <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
              <h3 style="margin:0 0 10px 0">Mail (Return Address)</h3>
              <div class="muted" style="margin-bottom:10px">Used when your AI agent sends physical mail via USPS.</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <input id="mailFromName" type="text" placeholder="Name (optional)">
                <input id="mailFromOrg" type="text" placeholder="Organization (optional)">
                <input id="mailFromAddress1" type="text" placeholder="Address line 1 *" style="grid-column:1 / span 2">
                <input id="mailFromAddress2" type="text" placeholder="Address line 2 (optional)" style="grid-column:1 / span 2">
                <input id="mailFromCity" type="text" placeholder="City *">
                <input id="mailFromState" type="text" placeholder="State *">
                <input id="mailFromPostal" type="text" placeholder="ZIP *">
                <select id="mailFromCountry">
                  <option value="US">US</option>
                </select>
              </div>
              <div class="toolbar" style="margin-top:10px">
                <button id="saveMailSettingsBtn">Save Mail</button>
                <span id="mailSettingsStatus" class="muted" style="margin-left:auto"></span>
              </div>
            </div>

            <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
              <h3 style="margin:0 0 10px 0">Document Templates</h3>
              <div class="muted" style="margin-bottom:10px">Upload a .docx with placeholders like <code>[[Name]]</code> and <code>[[Address]]</code>.</div>
              <div class="toolbar" style="flex-wrap:wrap">
                <input id="docTemplateName" type="text" placeholder="Template name" style="flex:1;min-width:160px">
                <input id="docTemplateFile" type="file" accept=".docx">
                <button id="uploadDocTemplateBtn" style="background:#4f46e5">Upload</button>
              </div>
              <table id="ai-doc-templates-table" style="display:none">
                <thead><tr><th>Name</th><th>File</th><th>Updated</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
              <div id="ai-doc-templates-empty" class="muted">Loading‚Ä¶</div>
            </div>
          </div>
        </div>

        <div id="ai-pane-meetings" style="display:none">
          <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
              <h3 style="margin:0">Meetings</h3>
              <div style="margin-left:auto"></div>
              <select id="aiMeetingsAgentFilter" style="width:170px">
                <option value="">All agents</option>
              </select>
              <button id="aiMeetingsRefreshBtn" type="button" style="background:#6b7280">Refresh</button>
            </div>

            <div class="toolbar" style="flex-wrap:wrap">
              <select id="aiMeetingsSendAgentId" style="width:170px">
                <option value="">Select agent‚Ä¶</option>
              </select>
              <input id="aiMeetingsSendEmail" type="email" placeholder="Caller email" style="width:240px">
              <input id="aiMeetingsSendSubject" type="text" placeholder="Subject (optional)" style="flex:1;min-width:220px">
              <button id="aiMeetingsSendBtn" type="button" style="background:#4f46e5">Send Link</button>
              <span id="aiMeetingsSendStatus" class="muted" style="margin-left:auto"></span>
            </div>

            <table id="ai-meetings-table" style="display:none">
              <thead><tr><th>Sent</th><th>To</th><th>Agent</th><th>Link</th><th>Status</th></tr></thead>
              <tbody></tbody>
            </table>
            <div id="ai-meetings-empty" class="muted">Loading‚Ä¶</div>
            <div class="toolbar" id="ai-meetings-pager" style="display:none">
              <button id="aiMeetingsPrev">Prev</button>
              <span id="aiMeetingsPageInfo" class="muted"></span>
              <button id="aiMeetingsNext">Next</button>
            </div>
          </div>
        </div>

        <div id="ai-pane-emails" style="display:none">
          <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
              <h3 style="margin:0">Emails</h3>
              <div style="margin-left:auto"></div>
              <select id="aiEmailsAgentFilter" style="width:170px">
                <option value="">All agents</option>
              </select>
              <select id="aiEmailsStatusFilter" style="width:150px">
                <option value="">All statuses</option>
                <option value="completed">Completed</option>
                <option value="pending">Pending</option>
                <option value="failed">Failed</option>
              </select>
              <button id="aiEmailsRefreshBtn" type="button" style="background:#6b7280">Refresh</button>
            </div>

            <table id="ai-emails-table" style="display:none">
              <thead><tr><th>Sent</th><th>To</th><th>Agent</th><th>Subject</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
            <div id="ai-emails-empty" class="muted">Loading‚Ä¶</div>
            <div class="toolbar" id="ai-emails-pager" style="display:none">
              <button id="aiEmailsPrev">Prev</button>
              <span id="aiEmailsPageInfo" class="muted"></span>
              <button id="aiEmailsNext">Next</button>
            </div>
          </div>
        </div>

        <div id="ai-pane-mail" style="display:none">
          <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
              <h3 style="margin:0">Mail</h3>
              <div style="margin-left:auto"></div>
              <select id="aiMailAgentFilter" style="width:170px">
                <option value="">All agents</option>
              </select>
              <button id="aiMailRefreshBtn" type="button" style="background:#6b7280">Refresh</button>
            </div>
            <table id="ai-mail-table" style="display:none">
              <thead><tr><th>Sent</th><th>To</th><th>Address</th><th>Agent</th><th>Tracking</th><th>Status</th><th>Cost</th></tr></thead>
              <tbody></tbody>
            </table>
            <div id="ai-mail-empty" class="muted">Loading‚Ä¶</div>
            <div class="toolbar" id="ai-mail-pager" style="display:none">
              <button id="aiMailPrev">Prev</button>
              <span id="aiMailPageInfo" class="muted"></span>
              <button id="aiMailNext">Next</button>
            </div>
          </div>
        </div>

        <div id="ai-pane-conversations" style="display:none">
          <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start">
            <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                <h3 style="margin:0">Inbound Sessions</h3>
                <div style="margin-left:auto"></div>
                <select id="aiConvAgentFilter" style="width:170px">
                  <option value="">All agents</option>
                </select>
                <button id="aiConvRefreshBtn" type="button" style="background:#6b7280">Refresh</button>
              </div>
              <table id="ai-conv-sessions-table" style="display:none">
                <thead><tr><th>Start</th><th>From</th><th>Agent</th><th>Msgs</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
              <div id="ai-conv-sessions-empty" class="muted">Loading‚Ä¶</div>
              <div class="toolbar" id="ai-conv-sessions-pager" style="display:none">
                <button id="aiConvPrev">Prev</button>
                <span id="aiConvPageInfo" class="muted"></span>
                <button id="aiConvNext">Next</button>
              </div>
            </div>

            <div style="flex:1;min-width:320px;background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;padding:12px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                <h3 style="margin:0">Conversation</h3>
                <span id="aiConvSessionMeta" class="muted" style="margin-left:auto"></span>
              </div>
              <div id="aiConvMessages" style="max-height:520px;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#f9fafb"></div>
              <div id="aiConvMessagesEmpty" class="muted" style="margin-top:8px">Select a session to view the transcript.</div>
            </div>
          </div>
        </div>
      </section>

      <section id="view-billing" style="display:none">
        <h2>Billing History</h2>
        <table id="billing-table" style="display:none">
          <thead><tr><th>Date</th><th>Amount</th><th>Description</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="toolbar" id="billing-pager" style="display:none">
          <button id="billingPrev">Prev</button>
          <span id="billingPageInfo" class="muted"></span>
          <button id="billingNext">Next</button>
        </div>
        <div id="billing-empty" class="muted">Loading‚Ä¶</div>
      </section>
    </main>
    <!-- Add Fund Modal -->
    <div id="addFundModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9998;align-items:center;justify-content:center">
      <div style="background:#fff;padding:24px;border-radius:12px;width:360px;max-width:90%">
        <h3 style="margin:0 0 16px 0">üí≥ Add Funds</h3>
        <div style="margin-bottom:12px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Amount ($)</label>
          <input id="fundAmount" type="number" min="<%= checkoutMinAmount || 100 %>" max="<%= checkoutMaxAmount || 500 %>" step="0.01" placeholder="Enter amount" style="width:100%;box-sizing:border-box">
        </div>
        <div style="margin-bottom:12px;font-size:13px;color:#4b5563">
          Payment method:
          <label style="margin-left:8px;cursor:pointer">
            <input type="radio" name="fundMethod" value="card" checked> Card
          </label>
          <label style="margin-left:8px;cursor:pointer">
            <input type="radio" name="fundMethod" value="crypto"> Crypto
          </label>
          <label style="margin-left:8px;cursor:pointer">
            <input type="radio" name="fundMethod" value="billcom"> ACH
          </label>
          <div style="margin-top:6px;font-size:12px;color:#6b7280">
            <div><strong>Card</strong>: instant credit after successful payment.</div>
            <div><strong>Crypto</strong>: credit is applied after network confirmations (may take several minutes).</div>
            <div><strong>ACH</strong>: credit is applied after invoice payment is confirmed (may take a few minutes).</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="cancelFundBtn" style="background:#6b7280">Cancel</button>
          <button id="confirmFundBtn" style="background:#059669">Continue</button>
        </div>
      </div>
    </div>
    <!-- SIP Account Modal -->
    <div id="sipModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9998;align-items:center;justify-content:center">
      <div style="background:#fff;padding:24px;border-radius:12px;width:380px;max-width:90%">
        <h3 style="margin:0 0 16px 0">üìû Create SIP Account</h3>
        <div style="margin-bottom:12px">
          <label style="display:block;margin-bottom:4px;font-size:13px">SIP Username *</label>
          <input id="newSipUser" type="text" placeholder="e.g. john_doe" style="width:100%;box-sizing:border-box">
        </div>
        <div style="margin-bottom:12px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Password *</label>
          <input id="newSipPass" type="password" placeholder="Enter a secure password" style="width:100%;box-sizing:border-box">
        </div>
        <div style="margin-bottom:16px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Caller ID * <span class="muted">(numbers only, 11 digits)</span></label>
          <input id="newSipCID" type="text" placeholder="e.g. 12025551234" inputmode="numeric" pattern="\d{11}" style="width:100%;box-sizing:border-box">
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="cancelSipBtn" style="background:#6b7280">Cancel</button>
          <button id="confirmSipBtn" style="background:#4f46e5">Create Account</button>
        </div>
      </div>
    </div>
    <!-- Trunk Modal -->
    <div id="trunkModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9998;align-items:center;justify-content:center">
      <div style="background:#fff;padding:24px;border-radius:12px;width:400px;max-width:90%">
        <h3 style="margin:0 0 16px 0" id="trunkModalTitle">‚Ü™Ô∏è Create Call Forwarding Trunk</h3>
        <div style="margin-bottom:12px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Trunk Name *</label>
          <input id="newTrunkName" type="text" placeholder="e.g. Office Forward" style="width:100%;box-sizing:border-box">
        </div>
        <div style="margin-bottom:12px">
          <label style="display:block;margin-bottom:4px;font-size:13px">PSTN Number * <span class="muted">(11 digits)</span></label>
          <input id="newTrunkDst" type="tel" placeholder="e.g. 12125551234" inputmode="tel" pattern="\d{11}" style="width:100%;box-sizing:border-box">
        </div>
        <div style="margin-bottom:12px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Description</label>
          <input id="newTrunkDesc" type="text" placeholder="Optional description" style="width:100%;box-sizing:border-box">
        </div>
        <div style="margin-bottom:16px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Capacity <span class="muted">(concurrent calls)</span></label>
          <input id="newTrunkCapacity" type="number" placeholder="Leave empty for unlimited" min="1" style="width:100%;box-sizing:border-box">
        </div>
        <input type="hidden" id="editTrunkId">
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="cancelTrunkBtn" style="background:#6b7280">Cancel</button>
          <button id="confirmTrunkBtn" style="background:#f59e0b">Create Trunk</button>
        </div>
      </div>
    </div>

    <!-- AI Agent Modal -->
    <div id="aiAgentModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9998;align-items:center;justify-content:center">
      <div class="ai-agent-modal-card" style="background:#fff;padding:14px;border-radius:10px;width:320px;max-width:92%;max-height:92vh;overflow:auto">
        <h3 style="margin:0 0 10px 0" id="aiAgentModalTitle">ü§ñ Create AI Agent</h3>
        <div style="margin-bottom:8px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Agent Name *</label>
          <input id="aiAgentName" type="text" placeholder="e.g. Support Agent" style="width:100%;box-sizing:border-box">
        </div>
        <div style="margin-bottom:8px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Greeting</label>
          <textarea id="aiAgentGreeting" rows="2" placeholder="What should the agent say when answering?" style="width:100%;box-sizing:border-box"></textarea>
        </div>
        <div style="margin-bottom:8px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Cartesia Voice</label>
          <div style="display:flex;gap:6px;align-items:center">
            <select id="aiAgentCartesiaVoiceSelect" style="flex:1;min-width:0">
              <option value="">Default voice</option>
              <option value="__custom__">Custom voice id‚Ä¶</option>
            </select>
            <button id="aiLoadVoicesBtn" type="button" style="background:#6b7280">Load Voices</button>
          </div>
          <div id="aiAgentCartesiaVoiceCustomWrap" style="display:none;margin-top:6px">
            <input id="aiAgentCartesiaVoiceCustom" type="text" placeholder="Paste Cartesia voice_id" style="width:100%;box-sizing:border-box">
          </div>
          <div class="muted" style="margin-top:4px">Leave as Default to use the voice configured in your agent image.</div>
        </div>
        <div style="margin-bottom:8px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Background Audio (WAV)</label>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="aiAgentBackgroundAudioFile" type="file" accept=".wav,audio/wav,audio/x-wav" style="flex:1;min-width:200px">
            <button id="aiRemoveBackgroundAudioBtn" type="button" style="background:#6b7280;display:none">Remove upload</button>
            <span class="muted" style="font-size:12px">Volume</span>
            <input id="aiAgentBackgroundAudioGain" type="number" min="0" max="0.2" step="0.01" placeholder="0.06" style="width:86px;box-sizing:border-box">
          </div>
          <div id="aiAgentBackgroundAudioFileName" class="muted" style="margin-top:4px">No file uploaded.</div>
          <div style="margin-top:6px">
            <input id="aiAgentBackgroundAudioUrl" type="url" placeholder="https://.../office.wav" style="width:100%;box-sizing:border-box">
          </div>
          <div class="muted" style="margin-top:4px">Uploaded WAV overrides the URL (URL acts as a fallback).</div>
        </div>
        <div style="margin-bottom:10px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Custom Prompt</label>
          <textarea id="aiAgentPrompt" rows="4" placeholder="Instructions for the agent..." style="width:100%;box-sizing:border-box"></textarea>
        </div>
        <div style="margin-bottom:10px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Transfer Destination (optional)</label>
          <input id="aiAgentTransferNumber" type="text" placeholder="Leave blank to use default (Tools ‚Üí Call Transfer)" style="width:100%;box-sizing:border-box">
          <div class="muted" style="margin-top:4px">Overrides the default transfer destination for this agent only.</div>
        </div>
        <div style="margin-bottom:10px">
          <label style="display:block;margin-bottom:4px;font-size:13px">Default Document Template</label>
          <select id="aiAgentDefaultTemplateSelect" style="width:100%;box-sizing:border-box">
            <option value="">None</option>
          </select>
          <div class="muted" style="margin-top:4px">Used when the agent emails a document to a caller.</div>
        </div>
        <input type="hidden" id="aiAgentId">
        <div style="display:flex;gap:6px;justify-content:flex-end">
          <button id="cancelAiAgentBtn" style="background:#6b7280">Cancel</button>
          <button id="confirmAiAgentBtn" style="background:#4f46e5">Save Agent</button>
        </div>
      </div>
    </div>

    <!-- AI Email Preview Modal -->
    <div id="aiEmailPreviewModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9998;align-items:center;justify-content:center">
      <div style="background:#fff;padding:16px;border-radius:12px;width:860px;max-width:95%;max-height:92vh;overflow:auto">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          <h3 style="margin:0">‚úâÔ∏è Email Preview</h3>
          <div style="margin-left:auto"></div>
          <button id="closeAiEmailPreviewBtn" type="button" style="background:#6b7280">Close</button>
        </div>
        <div id="aiEmailPreviewMeta" class="muted" style="margin-bottom:10px">Loading‚Ä¶</div>

        <div id="aiEmailPreviewAttachments" style="display:none;margin-bottom:12px">
          <div class="muted" style="margin-bottom:6px">Attachments</div>
          <ul id="aiEmailPreviewAttachmentsList" style="margin:0;padding-left:18px"></ul>
        </div>

        <div id="aiEmailPreviewRenderedWrap" style="display:none;margin-bottom:12px">
          <div class="muted" style="margin-bottom:6px">Rendered preview</div>
          <iframe id="aiEmailPreviewIframe" sandbox="" referrerpolicy="no-referrer" style="width:100%;height:420px;border:1px solid #e5e7eb;border-radius:12px;background:#ffffff"></iframe>
        </div>

        <div id="aiEmailPreviewTextWrap" style="display:none">
          <div class="muted" style="margin-bottom:6px">Text</div>
          <pre id="aiEmailPreviewText" style="margin:0;background:#0b1220;color:#e2e8f0;padding:10px;border-radius:12px;white-space:pre-wrap;max-height:360px;overflow:auto"></pre>
        </div>

        <div id="aiEmailPreviewEmpty" class="muted" style="display:none">No preview content captured for this email.</div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const LOCAL_DID_MARKUP = <%= typeof localDidMarkup !== 'undefined' ? localDidMarkup : 10.20 %> || 0;
    const TOLLFREE_DID_MARKUP = <%= typeof tollfreeDidMarkup !== 'undefined' ? tollfreeDidMarkup : 25.20 %> || 0;
    const CHECKOUT_MIN_AMOUNT = <%= typeof checkoutMinAmount !== 'undefined' ? checkoutMinAmount : 100 %>;
    const CHECKOUT_MAX_AMOUNT = <%= typeof checkoutMaxAmount !== 'undefined' ? checkoutMaxAmount : 500 %>;
    const SIP_DOMAIN = <%- JSON.stringify(typeof sipDomain !== 'undefined' ? sipDomain : '') %>;
    const $ = (s)=>document.querySelector(s);
    var billingPage = 0;
    var billingPageSize = 20;
    const tabs = {overview:$('#tab-overview'), profile:$('#tab-profile'), sip:$('#tab-sip'), trunk:$('#tab-trunk'), billing:$('#tab-billing'), buydid:$('#tab-buydid'), mydids:$('#tab-mydids'), ai:$('#tab-ai'), cdr:$('#tab-cdr')};
    const views = {overview:$('#view-overview'), profile:$('#view-profile'), sip:$('#view-sip'), trunk:$('#view-trunk'), billing:$('#view-billing'), buydid:$('#view-buydid'), mydids:$('#view-mydids'), ai:$('#view-ai'), cdr:$('#view-cdr')};
    function activate(name){
      Object.keys(tabs).forEach(k=>{ tabs[k].classList.toggle('active',k===name); views[k].style.display = (k===name?'block':'none'); });
    }

    // AI submenu tabs
    const aiSubtabs = {
      agents: document.getElementById('ai-subtab-agents'),
      conversations: document.getElementById('ai-subtab-conversations'),
      emails: document.getElementById('ai-subtab-emails'),
      meetings: document.getElementById('ai-subtab-meetings'),
      mail: document.getElementById('ai-subtab-mail'),
      tools: document.getElementById('ai-subtab-tools'),
    };
    const aiPanes = {
      agents: document.getElementById('ai-pane-agents'),
      conversations: document.getElementById('ai-pane-conversations'),
      emails: document.getElementById('ai-pane-emails'),
      meetings: document.getElementById('ai-pane-meetings'),
      mail: document.getElementById('ai-pane-mail'),
      tools: document.getElementById('ai-pane-tools'),
    };

    function activateAiSubtab(name){
      const n = String(name || '').toLowerCase();
      const active = (n === 'tools' || n === 'conversations' || n === 'emails' || n === 'meetings' || n === 'mail') ? n : 'agents';
      Object.keys(aiSubtabs).forEach(k => {
        const el = aiSubtabs[k];
        if (!el) return;
        el.classList.toggle('active', k === active);
      });
      Object.keys(aiPanes).forEach(k => {
        const el = aiPanes[k];
        if (!el) return;
        el.style.display = (k === active) ? 'block' : 'none';
      });
    }

    if (aiSubtabs.agents) {
      aiSubtabs.agents.addEventListener('click', (e) => {
        e.preventDefault();
        activateAiSubtab('agents');
        loadAiAgents();
        loadAiNumbers();
      });
    }
    if (aiSubtabs.tools) {
      aiSubtabs.tools.addEventListener('click', (e) => {
        e.preventDefault();
        activateAiSubtab('tools');
        loadSmtpSettings();
        loadAiTransferSettings();
        loadMailSettings();
        loadDocTemplates();
      });
    }
    if (aiSubtabs.conversations) {
      aiSubtabs.conversations.addEventListener('click', (e) => {
        e.preventDefault();
        activateAiSubtab('conversations');
        openAiConversationsTab();
      });
    }
    if (aiSubtabs.emails) {
      aiSubtabs.emails.addEventListener('click', (e) => {
        e.preventDefault();
        activateAiSubtab('emails');
        openAiEmailsTab();
      });
    }
    if (aiSubtabs.meetings) {
      aiSubtabs.meetings.addEventListener('click', (e) => {
        e.preventDefault();
        activateAiSubtab('meetings');
        openAiMeetingsTab();
      });
    }
    if (aiSubtabs.mail) {
      aiSubtabs.mail.addEventListener('click', (e) => {
        e.preventDefault();
        activateAiSubtab('mail');
        openAiMailTab();
      });
    }
    tabs.overview.addEventListener('click',e=>{e.preventDefault();activate('overview');loadStats();});
    tabs.profile.addEventListener('click',e=>{e.preventDefault();activate('profile');loadProfile();});
    tabs.sip.addEventListener('click',e=>{e.preventDefault();activate('sip');sipPage=0;loadSip();});
    tabs.trunk.addEventListener('click',e=>{e.preventDefault();activate('trunk');trunkPage=0;loadTrunks();});
    tabs.billing.addEventListener('click',e=>{e.preventDefault();activate('billing');billingPage=0;loadBillingHistory();});
    tabs.buydid.addEventListener('click',e=>{e.preventDefault();activate('buydid');loadCountries();});
    tabs.mydids.addEventListener('click',e=>{e.preventDefault();activate('mydids');mydidsPage=0;loadMyDids();});
    tabs.ai.addEventListener('click',e=>{e.preventDefault();activate('ai');activateAiSubtab('agents');loadAiAgents();loadAiNumbers();});
    tabs.cdr.addEventListener('click',e=>{e.preventDefault();activate('cdr');cdrPage=0;loadCdrDidOptions();loadCdr();});

    function grabRows(payload){
      const d = (payload && typeof payload === 'object') ? (payload.data ?? payload) : payload;
      if (Array.isArray(d)) return d;
      if (d && Array.isArray(d.items)) return d.items;
      if (d && Array.isArray(d.rows)) return d.rows;
      if (payload && Array.isArray(payload.rows)) return payload.rows;
      if (Array.isArray(payload)) return payload;
      return [];
    }

    // ========== AI Agents ==========
    let aiAgentsData = [];
    let aiNumbersData = [];
    let cartesiaVoicesLoaded = false;

    // AI email + doc templates
    let smtpHasPassword = false;
    let docTemplatesData = [];

    // AI Conversations
    let aiConvUiInit = false;
    let aiConvPage = 0;
    const aiConvPageSize = 25;
    let aiConvTotal = 0;
    let aiConvSessionsData = [];
    let aiConvSelected = null; // { call_id, call_domain }

    // AI Meetings
    let aiMeetingsUiInit = false;
    let aiMeetingsPage = 0;
    const aiMeetingsPageSize = 25;
    let aiMeetingsTotal = 0;
    let aiMeetingsData = [];

    // AI Emails
    let aiEmailsUiInit = false;
    let aiEmailsPage = 0;
    const aiEmailsPageSize = 25;
    let aiEmailsTotal = 0;
    let aiEmailsData = [];

    // AI Mail
    let aiMailUiInit = false;
    let aiMailPage = 0;
    const aiMailPageSize = 25;
    let aiMailTotal = 0;
    let aiMailData = [];

    function fmtDateTime(val){
      if (!val) return '';
      try {
        const d = new Date(val);
        if (!Number.isNaN(d.getTime())) return d.toLocaleString();
      } catch {}
      return String(val);
    }

    function clearAiConvMessages(msg){
      const box = $('#aiConvMessages');
      const empty = $('#aiConvMessagesEmpty');
      const meta = $('#aiConvSessionMeta');
      if (box) box.innerHTML = '';
      if (meta) meta.textContent = '';
      if (empty) {
        empty.style.display = 'block';
        empty.textContent = msg || 'Select a session to view the transcript.';
      }
    }

    function renderAiConvAgentFilter(){
      const sel = $('#aiConvAgentFilter');
      if (!sel) return;
      const current = String(sel.value || '');
      sel.innerHTML = '';
      sel.appendChild(new Option('All agents', ''));
      for (const a of (aiAgentsData || [])) {
        const id = a && a.id != null ? String(a.id) : '';
        if (!id) continue;
        const name = String(a.display_name || '').trim();
        sel.appendChild(new Option(name || `Agent ${id}`, id));
      }
      const still = Array.from(sel.options || []).some(o => String(o.value) === current);
      sel.value = still ? current : '';
    }

    function initAiConversationsUI(){
      if (aiConvUiInit) return;
      aiConvUiInit = true;

      const refreshBtn = $('#aiConvRefreshBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', (e) => { e.preventDefault(); loadAiConversationSessions(); });

      const agentSel = $('#aiConvAgentFilter');
      if (agentSel) agentSel.addEventListener('change', () => {
        aiConvPage = 0;
        aiConvSelected = null;
        clearAiConvMessages();
        loadAiConversationSessions();
      });

      const prev = $('#aiConvPrev');
      if (prev) prev.addEventListener('click', (e) => {
        e.preventDefault();
        if (aiConvPage > 0) {
          aiConvPage -= 1;
          loadAiConversationSessions();
        }
      });

      const next = $('#aiConvNext');
      if (next) next.addEventListener('click', (e) => {
        e.preventDefault();
        if ((aiConvPage + 1) * aiConvPageSize < aiConvTotal) {
          aiConvPage += 1;
          loadAiConversationSessions();
        }
      });

      document.addEventListener('click', (ev) => {
        const t = ev.target;
        if (!t || !t.classList || !t.classList.contains('ai-conv-open')) return;
        ev.preventDefault();
        const callId = String(t.getAttribute('data-call-id') || '');
        const callDomain = String(t.getAttribute('data-call-domain') || '');
        const found = (aiConvSessionsData || []).find(s => String(s.call_id || '') === callId && String(s.call_domain || '') === callDomain);
        if (found) {
          selectAiConversationSession(found);
        } else if (callId && callDomain) {
          selectAiConversationSession({ call_id: callId, call_domain: callDomain });
        }
      });
    }

    async function openAiConversationsTab(){
      initAiConversationsUI();

      // Populate agent filter
      try {
        if (!Array.isArray(aiAgentsData) || aiAgentsData.length === 0) {
          await loadAiAgents();
        }
      } catch {}
      renderAiConvAgentFilter();

      // Load sessions
      loadAiConversationSessions();
    }

    // ========== AI Meetings ==========
    function renderAiMeetingsAgentFilter(){
      const sel = $('#aiMeetingsAgentFilter');
      if (!sel) return;
      const current = String(sel.value || '');
      sel.innerHTML = '';
      sel.appendChild(new Option('All agents', ''));
      for (const a of (aiAgentsData || [])) {
        const id = a && a.id != null ? String(a.id) : '';
        if (!id) continue;
        const name = String(a.display_name || '').trim();
        sel.appendChild(new Option(name || `Agent ${id}`, id));
      }
      const still = Array.from(sel.options || []).some(o => String(o.value) === current);
      sel.value = still ? current : '';
    }

    function renderAiMeetingsSendAgentSelect(){
      const sel = $('#aiMeetingsSendAgentId');
      if (!sel) return;
      const current = String(sel.value || '');
      sel.innerHTML = '';
      sel.appendChild(new Option('Select agent‚Ä¶', ''));
      for (const a of (aiAgentsData || [])) {
        const id = a && a.id != null ? String(a.id) : '';
        if (!id) continue;
        const name = String(a.display_name || '').trim();
        sel.appendChild(new Option(name || `Agent ${id}`, id));
      }
      const still = Array.from(sel.options || []).some(o => String(o.value) === current);
      sel.value = still ? current : '';

      // Default the send-agent to the current filter selection (if any)
      // only when a send-agent isn't already selected.
      if (!sel.value) {
        const filterSel = $('#aiMeetingsAgentFilter');
        const filterVal = filterSel ? String(filterSel.value || '').trim() : '';
        if (filterVal && Array.from(sel.options || []).some(o => String(o.value) === filterVal)) {
          sel.value = filterVal;
        }
      }
    }

    function setAiMeetingsSendStatus(msg, isError){
      const el = $('#aiMeetingsSendStatus');
      if (!el) return;
      el.textContent = msg || '';
      el.style.color = isError ? '#b91c1c' : '#6b7280';
    }

    async function sendAiMeetingLink(){
      const btn = $('#aiMeetingsSendBtn');
      const agentSel = $('#aiMeetingsSendAgentId');
      const emailEl = $('#aiMeetingsSendEmail');
      const subjectEl = $('#aiMeetingsSendSubject');

      const agentId = agentSel ? String(agentSel.value || '').trim() : '';
      const toEmail = emailEl ? String(emailEl.value || '').trim() : '';
      const subject = subjectEl ? String(subjectEl.value || '').trim() : '';

      if (!agentId) {
        setAiMeetingsSendStatus('Select an agent.', true);
        return;
      }
      if (!toEmail) {
        setAiMeetingsSendStatus('Enter a caller email.', true);
        return;
      }

      if (btn) btn.disabled = true;
      setAiMeetingsSendStatus('Sending‚Ä¶', false);

      let clientRequestId = '';
      try {
        clientRequestId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : '';
      } catch {}
      if (!clientRequestId) {
        clientRequestId = `req_${Date.now()}_${Math.random().toString(16).slice(2)}`;
      }

      try {
        const payload = {
          agent_id: agentId,
          to_email: toEmail,
          subject: subject || undefined,
          client_request_id: clientRequestId
        };

        const r = await fetch('/api/me/ai/meetings/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const j = await r.json().catch(() => null);
        if (!r.ok || !j || j.success === false) {
          setAiMeetingsSendStatus(j?.message || 'Failed to send meeting link', true);
          return;
        }

        setAiMeetingsSendStatus(j.already_sent ? 'Already sent.' : 'Sent.', false);
        if (j.join_url || j.room_url) {
          const url = String(j.join_url || j.room_url);
          showLinkToast('Meeting link ready.', 'Open meeting', url, 'success');
        }
        aiMeetingsPage = 0;
        loadAiMeetings();
      } catch (e) {
        setAiMeetingsSendStatus('Failed to send meeting link', true);
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    function initAiMeetingsUI(){
      if (aiMeetingsUiInit) return;
      aiMeetingsUiInit = true;

      const refreshBtn = $('#aiMeetingsRefreshBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', (e) => { e.preventDefault(); loadAiMeetings(); });

      const agentSel = $('#aiMeetingsAgentFilter');
      if (agentSel) agentSel.addEventListener('change', () => {
        aiMeetingsPage = 0;
        renderAiMeetingsSendAgentSelect();
        loadAiMeetings();
      });

      const sendBtn = $('#aiMeetingsSendBtn');
      if (sendBtn) sendBtn.addEventListener('click', (e) => { e.preventDefault(); sendAiMeetingLink(); });

      const sendEmail = $('#aiMeetingsSendEmail');
      if (sendEmail) sendEmail.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendAiMeetingLink();
        }
      });

      const prev = $('#aiMeetingsPrev');
      if (prev) prev.addEventListener('click', (e) => {
        e.preventDefault();
        if (aiMeetingsPage > 0) {
          aiMeetingsPage -= 1;
          loadAiMeetings();
        }
      });

      const next = $('#aiMeetingsNext');
      if (next) next.addEventListener('click', (e) => {
        e.preventDefault();
        if ((aiMeetingsPage + 1) * aiMeetingsPageSize < aiMeetingsTotal) {
          aiMeetingsPage += 1;
          loadAiMeetings();
        }
      });
    }

    async function openAiMeetingsTab(){
      initAiMeetingsUI();

      // Populate agent filter
      try {
        if (!Array.isArray(aiAgentsData) || aiAgentsData.length === 0) {
          await loadAiAgents();
        }
      } catch {}
      renderAiMeetingsAgentFilter();
      renderAiMeetingsSendAgentSelect();

      loadAiMeetings();
    }

    function renderAiMeetings(){
      const table = $('#ai-meetings-table');
      const empty = $('#ai-meetings-empty');
      const pager = $('#ai-meetings-pager');
      const pageInfo = $('#aiMeetingsPageInfo');
      const prev = $('#aiMeetingsPrev');
      const next = $('#aiMeetingsNext');
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!aiMeetingsData || !aiMeetingsData.length) {
        table.style.display = 'none';
        if (pager) pager.style.display = 'none';
        if (pageInfo) pageInfo.textContent = '';
        empty.style.display = 'block';
        empty.textContent = 'No meetings yet.';
        return;
      }

      for (const m of aiMeetingsData) {
        const sent = m.created_at ? fmtDateTime(m.created_at) : '';
        const to = String(m.to_email || '-');
        const agentName = String(m.agent_name || '-');
        const url = String(m.meeting_join_url || m.meeting_room_url || '');
        const statusRaw = String(m.meeting_status || '').toLowerCase();
        const label = statusRaw === 'live' ? 'Live' : statusRaw === 'ended' ? 'Ended' : 'Unknown';

        const tr = document.createElement('tr');

        const tdSent = document.createElement('td');
        tdSent.textContent = sent;
        tr.appendChild(tdSent);

        const tdTo = document.createElement('td');
        tdTo.textContent = to;
        tr.appendChild(tdTo);

        const tdAgent = document.createElement('td');
        tdAgent.textContent = agentName;
        tr.appendChild(tdAgent);

        const tdLink = document.createElement('td');
        if (url) {
          const a = document.createElement('a');
          a.href = url;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.textContent = 'Open';
          tdLink.appendChild(a);
        } else {
          tdLink.textContent = '-';
        }
        tr.appendChild(tdLink);

        const tdStatus = document.createElement('td');
        tdStatus.textContent = label;
        tdStatus.style.fontWeight = '600';
        tdStatus.style.color = (statusRaw === 'live') ? '#16a34a' : '#6b7280';
        tr.appendChild(tdStatus);

        tbody.appendChild(tr);
      }

      empty.style.display = 'none';
      table.style.display = 'table';

      const totalPages = aiMeetingsTotal > 0 ? Math.max(1, Math.ceil(aiMeetingsTotal / aiMeetingsPageSize)) : 1;
      if (pageInfo) pageInfo.textContent = `Page ${aiMeetingsPage + 1} of ${totalPages}`;

      if (pager) {
        pager.style.display = (aiMeetingsTotal > aiMeetingsPageSize) ? 'flex' : 'none';
      }
      if (prev) prev.disabled = (aiMeetingsPage <= 0);
      if (next) next.disabled = ((aiMeetingsPage + 1) * aiMeetingsPageSize >= aiMeetingsTotal);
    }

    async function loadAiMeetings(){
      const table = $('#ai-meetings-table');
      const empty = $('#ai-meetings-empty');
      const pager = $('#ai-meetings-pager');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      if (pager) pager.style.display = 'none';

      try {
        const agentSel = $('#aiMeetingsAgentFilter');
        const agentId = agentSel ? String(agentSel.value || '').trim() : '';
        const url = `/api/me/ai/meetings?page=${aiMeetingsPage}&pageSize=${aiMeetingsPageSize}` + (agentId ? `&agent_id=${encodeURIComponent(agentId)}` : '');
        const r = await fetch(url);
        const j = await r.json();
        if (!j || j.success === false) {
          aiMeetingsData = [];
          aiMeetingsTotal = 0;
          renderAiMeetings();
          if (empty) empty.textContent = j?.message || 'Failed to load meetings';
          return;
        }
        aiMeetingsData = Array.isArray(j.data) ? j.data : [];
        const total = Number(j.total);
        aiMeetingsTotal = Number.isFinite(total) ? total : aiMeetingsData.length;

        // If current page is out of bounds (e.g. filter changed), jump back and refetch.
        if (aiMeetingsTotal > 0 && aiMeetingsPage > 0 && aiMeetingsPage * aiMeetingsPageSize >= aiMeetingsTotal) {
          aiMeetingsPage = 0;
          return loadAiMeetings();
        }

        renderAiMeetings();
      } catch (e) {
        aiMeetingsData = [];
        aiMeetingsTotal = 0;
        renderAiMeetings();
        if (empty) empty.textContent = 'Failed to load meetings';
      }
    }

    // ========== AI Emails ==========
    function renderAiEmailsAgentFilter(){
      const sel = $('#aiEmailsAgentFilter');
      if (!sel) return;
      const current = String(sel.value || '');
      sel.innerHTML = '';
      sel.appendChild(new Option('All agents', ''));
      for (const a of (aiAgentsData || [])) {
        const id = a && a.id != null ? String(a.id) : '';
        if (!id) continue;
        const name = String(a.display_name || '').trim();
        sel.appendChild(new Option(name || `Agent ${id}`, id));
      }
      const still = Array.from(sel.options || []).some(o => String(o.value) === current);
      sel.value = still ? current : '';
    }

    function aiEmailKindLabel(e){
      const hasMeeting = !!(e && (e.meeting_provider || e.meeting_room_url || e.meeting_join_url));
      if (hasMeeting) return 'Meeting';
      if (e && e.template_id != null) return 'Document';
      return 'Email';
    }

    function closeAiEmailPreview(){
      const modal = $('#aiEmailPreviewModal');
      if (modal) modal.style.display = 'none';

      const iframe = $('#aiEmailPreviewIframe');
      if (iframe) iframe.srcdoc = '';

      const meta = $('#aiEmailPreviewMeta');
      if (meta) meta.textContent = '';

      const attWrap = $('#aiEmailPreviewAttachments');
      if (attWrap) attWrap.style.display = 'none';
      const attList = $('#aiEmailPreviewAttachmentsList');
      if (attList) attList.innerHTML = '';

      const rend = $('#aiEmailPreviewRenderedWrap');
      if (rend) rend.style.display = 'none';
      const txtWrap = $('#aiEmailPreviewTextWrap');
      if (txtWrap) txtWrap.style.display = 'none';
      const txt = $('#aiEmailPreviewText');
      if (txt) txt.textContent = '';

      const empty = $('#aiEmailPreviewEmpty');
      if (empty) empty.style.display = 'none';
    }

    function openAiEmailPreviewModal(){
      const modal = $('#aiEmailPreviewModal');
      if (modal) modal.style.display = 'flex';
    }

    async function openAiEmailPreview(id){
      const modal = $('#aiEmailPreviewModal');
      const meta = $('#aiEmailPreviewMeta');
      const attWrap = $('#aiEmailPreviewAttachments');
      const attList = $('#aiEmailPreviewAttachmentsList');
      const rend = $('#aiEmailPreviewRenderedWrap');
      const iframe = $('#aiEmailPreviewIframe');
      const txtWrap = $('#aiEmailPreviewTextWrap');
      const txt = $('#aiEmailPreviewText');
      const empty = $('#aiEmailPreviewEmpty');

      openAiEmailPreviewModal();

      if (meta) meta.textContent = 'Loading‚Ä¶';
      if (attWrap) attWrap.style.display = 'none';
      if (attList) attList.innerHTML = '';
      if (rend) rend.style.display = 'none';
      if (iframe) iframe.srcdoc = '';
      if (txtWrap) txtWrap.style.display = 'none';
      if (txt) txt.textContent = '';
      if (empty) empty.style.display = 'none';

      try {
        const r = await fetch(`/api/me/ai/emails/${encodeURIComponent(String(id))}`);
        const j = await r.json().catch(() => null);
        if (!r.ok || !j || j.success === false) {
          if (meta) meta.textContent = j?.message || 'Failed to load email';
          if (empty) empty.style.display = 'block';
          return;
        }

        const e = j.data || {};

        const to = String(e.to_email || '-');
        const subj = String(e.subject || '-');
        const agentName = String(e.agent_name || '-');
        const sent = e.created_at ? fmtDateTime(e.created_at) : '';
        const statusRaw = String(e.status || '').toLowerCase() || 'unknown';
        const kind = aiEmailKindLabel(e);

        if (meta) {
          const parts = [];
          if (sent) parts.push(`Sent: ${sent}`);
          parts.push(`To: ${to}`);
          parts.push(`Agent: ${agentName}`);
          parts.push(`Subject: ${subj}`);
          parts.push(`Type: ${kind}`);
          parts.push(`Status: ${statusRaw}`);
          if (e.meeting_join_url || e.meeting_room_url) {
            parts.push(`Meeting: ${String(e.meeting_join_url || e.meeting_room_url)}`);
          }
          meta.textContent = parts.join(' ‚Ä¢ ');
        }

        // Attachments
        let attachments = [];
        const rawAtt = e.attachments_json;
        if (rawAtt) {
          try {
            attachments = Array.isArray(rawAtt) ? rawAtt : JSON.parse(String(rawAtt));
          } catch {
            attachments = [];
          }
        }
        if (Array.isArray(attachments) && attachments.length && attWrap && attList) {
          attList.innerHTML = '';
          for (const a of attachments) {
            const li = document.createElement('li');
            const fn = String(a?.filename || a?.name || 'attachment');
            const ct = String(a?.content_type || a?.contentType || '').trim();
            const sz = (a?.size_bytes != null && Number.isFinite(Number(a.size_bytes))) ? Number(a.size_bytes) : null;
            li.textContent = fn + (ct ? ` (${ct})` : '') + (sz != null ? ` ‚Ä¢ ${sz} bytes` : '');
            attList.appendChild(li);
          }
          attWrap.style.display = 'block';
        }

        // Email content (fallback for older rows)
        let emailText = (e.email_text != null) ? String(e.email_text) : '';
        let emailHtml = (e.email_html != null) ? String(e.email_html) : '';

        if (!emailText.trim() && !emailHtml.trim()) {
          const joinUrl = String(e.meeting_join_url || e.meeting_room_url || '').trim();
          if (joinUrl) {
            emailText = `Here is your video meeting link:\n\n${joinUrl}\n\nOpen it in your browser to join.`;
            emailHtml = `<div style="font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;">`+
              `<p>Here is your video meeting link:</p>`+
              `<p><a href="${joinUrl}">${joinUrl}</a></p>`+
              `<p>Open it in your browser to join.</p>`+
              `</div>`;
          } else if (e.template_id != null) {
            emailText = 'Please find your document attached.';
          }
        }

        const hasHtml = !!emailHtml.trim();
        const hasText = !!emailText.trim();

        if (hasHtml && rend && iframe) {
          const doc = `<!doctype html><html><head><meta charset="utf-8">`+
            `<base target="_blank">`+
            `<style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:12px;margin:0}</style>`+
            `</head><body>${emailHtml}</body></html>`;
          iframe.srcdoc = doc;
          rend.style.display = 'block';
        }

        if (hasText && txtWrap && txt) {
          txt.textContent = emailText;
          txtWrap.style.display = 'block';
        }

        if (!hasHtml && !hasText && empty) {
          empty.style.display = 'block';
        }
      } catch (e) {
        if (meta) meta.textContent = 'Failed to load email';
        if (empty) empty.style.display = 'block';
      }
    }

    function initAiEmailsUI(){
      if (aiEmailsUiInit) return;
      aiEmailsUiInit = true;

      const refreshBtn = $('#aiEmailsRefreshBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', (e) => { e.preventDefault(); loadAiEmails(); });

      const agentSel = $('#aiEmailsAgentFilter');
      if (agentSel) agentSel.addEventListener('change', () => {
        aiEmailsPage = 0;
        loadAiEmails();
      });

      const statusSel = $('#aiEmailsStatusFilter');
      if (statusSel) statusSel.addEventListener('change', () => {
        aiEmailsPage = 0;
        loadAiEmails();
      });

      const prev = $('#aiEmailsPrev');
      if (prev) prev.addEventListener('click', (e) => {
        e.preventDefault();
        if (aiEmailsPage > 0) {
          aiEmailsPage -= 1;
          loadAiEmails();
        }
      });

      const next = $('#aiEmailsNext');
      if (next) next.addEventListener('click', (e) => {
        e.preventDefault();
        if ((aiEmailsPage + 1) * aiEmailsPageSize < aiEmailsTotal) {
          aiEmailsPage += 1;
          loadAiEmails();
        }
      });

      const closeBtn = $('#closeAiEmailPreviewBtn');
      if (closeBtn) closeBtn.addEventListener('click', (e) => { e.preventDefault(); closeAiEmailPreview(); });

      const modal = $('#aiEmailPreviewModal');
      if (modal) modal.addEventListener('click', (e) => {
        if (e && e.target === modal) closeAiEmailPreview();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeAiEmailPreview();
        }
      });

      document.addEventListener('click', (ev) => {
        const t = ev.target;
        if (!t || !t.classList || !t.classList.contains('ai-email-preview')) return;
        ev.preventDefault();
        const id = String(t.getAttribute('data-id') || '').trim();
        if (id) openAiEmailPreview(id);
      });
    }

    async function openAiEmailsTab(){
      initAiEmailsUI();

      try {
        if (!Array.isArray(aiAgentsData) || aiAgentsData.length === 0) {
          await loadAiAgents();
        }
      } catch {}
      renderAiEmailsAgentFilter();

      loadAiEmails();
    }

    function renderAiEmails(){
      const table = $('#ai-emails-table');
      const empty = $('#ai-emails-empty');
      const pager = $('#ai-emails-pager');
      const pageInfo = $('#aiEmailsPageInfo');
      const prev = $('#aiEmailsPrev');
      const next = $('#aiEmailsNext');
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!aiEmailsData || !aiEmailsData.length) {
        table.style.display = 'none';
        if (pager) pager.style.display = 'none';
        if (pageInfo) pageInfo.textContent = '';
        empty.style.display = 'block';
        empty.textContent = 'No emails yet.';
        return;
      }

      for (const e of aiEmailsData) {
        const sent = e.created_at ? fmtDateTime(e.created_at) : '';
        const to = String(e.to_email || '-');
        const agentName = String(e.agent_name || '-');
        const subj = String(e.subject || '-');
        const kind = aiEmailKindLabel(e);
        const statusRaw = String(e.status || e.email_status || '').toLowerCase();
        const statusLabel = statusRaw ? (statusRaw.charAt(0).toUpperCase() + statusRaw.slice(1)) : 'Unknown';

        const tr = document.createElement('tr');

        const tdSent = document.createElement('td');
        tdSent.textContent = sent;
        tr.appendChild(tdSent);

        const tdTo = document.createElement('td');
        tdTo.textContent = to;
        tr.appendChild(tdTo);

        const tdAgent = document.createElement('td');
        tdAgent.textContent = agentName;
        tr.appendChild(tdAgent);

        const tdSubj = document.createElement('td');
        tdSubj.textContent = subj;
        tr.appendChild(tdSubj);

        const tdKind = document.createElement('td');
        tdKind.textContent = kind;
        tr.appendChild(tdKind);

        const tdStatus = document.createElement('td');
        tdStatus.textContent = statusLabel;
        tdStatus.style.fontWeight = '600';
        tdStatus.style.color = (statusRaw === 'completed') ? '#16a34a' : (statusRaw === 'failed' ? '#ef4444' : '#6b7280');
        if (e.error) tdStatus.title = String(e.error);
        tr.appendChild(tdStatus);

        const tdActions = document.createElement('td');
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'ai-email-preview';
        btn.setAttribute('data-id', String(e.id));
        btn.textContent = 'Preview';
        tdActions.appendChild(btn);

        const joinUrl = String(e.meeting_join_url || e.meeting_room_url || '').trim();
        if (joinUrl) {
          const spacer = document.createTextNode(' ');
          tdActions.appendChild(spacer);
          const a = document.createElement('a');
          a.href = joinUrl;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.textContent = 'Open link';
          tdActions.appendChild(a);
        }

        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      }

      empty.style.display = 'none';
      table.style.display = 'table';

      const totalPages = aiEmailsTotal > 0 ? Math.max(1, Math.ceil(aiEmailsTotal / aiEmailsPageSize)) : 1;
      if (pageInfo) pageInfo.textContent = `Page ${aiEmailsPage + 1} of ${totalPages}`;

      if (pager) {
        pager.style.display = (aiEmailsTotal > aiEmailsPageSize) ? 'flex' : 'none';
      }
      if (prev) prev.disabled = (aiEmailsPage <= 0);
      if (next) next.disabled = ((aiEmailsPage + 1) * aiEmailsPageSize >= aiEmailsTotal);
    }

    async function loadAiEmails(){
      const table = $('#ai-emails-table');
      const empty = $('#ai-emails-empty');
      const pager = $('#ai-emails-pager');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      if (pager) pager.style.display = 'none';

      try {
        const agentSel = $('#aiEmailsAgentFilter');
        const statusSel = $('#aiEmailsStatusFilter');
        const agentId = agentSel ? String(agentSel.value || '').trim() : '';
        const status = statusSel ? String(statusSel.value || '').trim().toLowerCase() : '';

        const url = `/api/me/ai/emails?page=${aiEmailsPage}&pageSize=${aiEmailsPageSize}`
          + (agentId ? `&agent_id=${encodeURIComponent(agentId)}` : '')
          + (status ? `&status=${encodeURIComponent(status)}` : '');

        const r = await fetch(url);
        const j = await r.json();
        if (!j || j.success === false) {
          aiEmailsData = [];
          aiEmailsTotal = 0;
          renderAiEmails();
          if (empty) empty.textContent = j?.message || 'Failed to load emails';
          return;
        }

        aiEmailsData = Array.isArray(j.data) ? j.data : [];
        const total = Number(j.total);
        aiEmailsTotal = Number.isFinite(total) ? total : aiEmailsData.length;

        if (aiEmailsTotal > 0 && aiEmailsPage > 0 && aiEmailsPage * aiEmailsPageSize >= aiEmailsTotal) {
          aiEmailsPage = 0;
          return loadAiEmails();
        }

        renderAiEmails();
      } catch (e) {
        aiEmailsData = [];
        aiEmailsTotal = 0;
        renderAiEmails();
        if (empty) empty.textContent = 'Failed to load emails';
      }
    }

    // ========== AI Mail ==========
    function renderAiMailAgentFilter(){
      const sel = $('#aiMailAgentFilter');
      if (!sel) return;
      const current = String(sel.value || '');
      sel.innerHTML = '';
      sel.appendChild(new Option('All agents', ''));
      for (const a of (aiAgentsData || [])) {
        const id = a && a.id != null ? String(a.id) : '';
        if (!id) continue;
        const name = String(a.display_name || '').trim();
        sel.appendChild(new Option(name || `Agent ${id}`, id));
      }
      const still = Array.from(sel.options || []).some(o => String(o.value) === current);
      sel.value = still ? current : '';
    }

    function initAiMailUI(){
      if (aiMailUiInit) return;
      aiMailUiInit = true;

      const refreshBtn = $('#aiMailRefreshBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', (e) => { e.preventDefault(); loadAiMail(true); });

      const agentSel = $('#aiMailAgentFilter');
      if (agentSel) agentSel.addEventListener('change', () => {
        aiMailPage = 0;
        loadAiMail(false);
      });

      const prev = $('#aiMailPrev');
      if (prev) prev.addEventListener('click', (e) => {
        e.preventDefault();
        if (aiMailPage > 0) {
          aiMailPage -= 1;
          loadAiMail(false);
        }
      });

      const next = $('#aiMailNext');
      if (next) next.addEventListener('click', (e) => {
        e.preventDefault();
        if ((aiMailPage + 1) * aiMailPageSize < aiMailTotal) {
          aiMailPage += 1;
          loadAiMail(false);
        }
      });
    }

    async function openAiMailTab(){
      initAiMailUI();

      try {
        if (!Array.isArray(aiAgentsData) || aiAgentsData.length === 0) {
          await loadAiAgents();
        }
      } catch {}
      renderAiMailAgentFilter();

      loadAiMail(false);
    }

    function formatAiMailAddress(m){
      const addr1 = (m.corrected_to_address1 || m.to_address1 || '').trim();
      const addr2 = (m.corrected_to_address2 || m.to_address2 || '').trim();
      const addr3 = (m.corrected_to_address3 || m.to_address3 || '').trim();
      const city = (m.corrected_to_city || m.to_city || '').trim();
      const state = (m.corrected_to_state || m.to_state || '').trim();
      const zip = (m.corrected_to_postal_code || m.to_postal_code || '').trim();
      const parts = [addr1, addr2, addr3].filter(Boolean);
      const last = [city, state, zip].filter(Boolean).join(' ');
      if (last) parts.push(last);
      return parts.join(', ');
    }

    function formatAiMailToLabel(m){
      const name = String(m.corrected_to_name || m.to_name || '').trim();
      const org = String(m.corrected_to_organization || m.to_organization || '').trim();
      if (name && org) return `${name} (${org})`;
      return name || org || '-';
    }

    function renderAiMail(){
      const table = $('#ai-mail-table');
      const empty = $('#ai-mail-empty');
      const pager = $('#ai-mail-pager');
      const pageInfo = $('#aiMailPageInfo');
      const prev = $('#aiMailPrev');
      const next = $('#aiMailNext');
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!aiMailData || !aiMailData.length) {
        table.style.display = 'none';
        if (pager) pager.style.display = 'none';
        if (pageInfo) pageInfo.textContent = '';
        empty.style.display = 'block';
        empty.textContent = 'No mail yet.';
        return;
      }

      for (const m of aiMailData) {
        const sent = m.created_at ? fmtDateTime(m.created_at) : '';
        const toLabel = formatAiMailToLabel(m);
        const addr = formatAiMailAddress(m);
        const agentName = String(m.agent_name || '-');
        const tracking = String(m.tracking_number || '-');
        const statusRaw = String(m.status || '').toLowerCase();

        const refundStatus = String(m.refund_status || '').toLowerCase();
        const refunded = (refundStatus === 'completed') || !!m.refunded_at || (Number(m.refund_billing_history_id) > 0);

        let statusText = statusRaw ? (statusRaw.charAt(0).toUpperCase() + statusRaw.slice(1)) : 'Unknown';
        if (statusRaw === 'failed' && refunded) statusText = 'Failed (Refunded)';
        if (statusRaw === 'failed' && refundStatus === 'failed') statusText = 'Failed (Refund failed)';

        const baseCostNum = (m.cost_estimate != null ? Number(m.cost_estimate) : null);
        const markupNum = (m.markup_amount != null ? Number(m.markup_amount) : null);
        const totalCostNum = (m.total_cost != null ? Number(m.total_cost) : null);
        const displayCostNum = (totalCostNum != null && Number.isFinite(totalCostNum))
          ? totalCostNum
          : ((baseCostNum != null && Number.isFinite(baseCostNum)) ? baseCostNum : null);
        const cost = (displayCostNum != null) ? `$${displayCostNum.toFixed(2)}` : '-';

        const tr = document.createElement('tr');

        const tdSent = document.createElement('td');
        tdSent.textContent = sent;
        tr.appendChild(tdSent);

        const tdTo = document.createElement('td');
        tdTo.textContent = toLabel;
        tr.appendChild(tdTo);

        const tdAddr = document.createElement('td');
        tdAddr.textContent = addr || '-';
        tr.appendChild(tdAddr);

        const tdAgent = document.createElement('td');
        tdAgent.textContent = agentName;
        tr.appendChild(tdAgent);

        const tdTrack = document.createElement('td');
        tdTrack.textContent = tracking;
        tr.appendChild(tdTrack);

        const tdStatus = document.createElement('td');
        tdStatus.textContent = statusText;
        tdStatus.style.fontWeight = '600';
        tdStatus.style.color = (statusRaw === 'completed') ? '#16a34a' : (statusRaw === 'failed' ? '#ef4444' : '#6b7280');

        const statusHints = [];
        if (m.error) statusHints.push(String(m.error));
        if (refunded) {
          const amt = (m.refund_amount != null && Number.isFinite(Number(m.refund_amount))) ? Number(m.refund_amount) : null;
          statusHints.push(`Refunded${amt != null ? `: $${amt.toFixed(2)}` : ''}`);
        } else if (refundStatus === 'failed' && m.refund_error) {
          statusHints.push(`Refund failed: ${String(m.refund_error)}`);
        }
        if (statusHints.length) tdStatus.title = statusHints.join(' | ');

        tr.appendChild(tdStatus);

        const tdCost = document.createElement('td');
        tdCost.textContent = cost;
        const hasBase = (baseCostNum != null && Number.isFinite(baseCostNum));
        const hasMarkup = (markupNum != null && Number.isFinite(markupNum) && markupNum > 0);
        const hasTotal = (totalCostNum != null && Number.isFinite(totalCostNum) && totalCostNum > 0);
        const parts = [];
        if (hasBase) parts.push(`Base: $${baseCostNum.toFixed(2)}`);
        if (hasMarkup) parts.push(`Markup: $${markupNum.toFixed(2)}`);
        if (hasTotal) parts.push(`Total: $${totalCostNum.toFixed(2)}`);
        if (refunded) parts.push('Refunded');
        if (parts.length) tdCost.title = parts.join(' | ');
        tr.appendChild(tdCost);

        tbody.appendChild(tr);
      }

      empty.style.display = 'none';
      table.style.display = 'table';

      const totalPages = aiMailTotal > 0 ? Math.max(1, Math.ceil(aiMailTotal / aiMailPageSize)) : 1;
      if (pageInfo) pageInfo.textContent = `Page ${aiMailPage + 1} of ${totalPages}`;

      if (pager) {
        pager.style.display = (aiMailTotal > aiMailPageSize) ? 'flex' : 'none';
      }
      if (prev) prev.disabled = (aiMailPage <= 0);
      if (next) next.disabled = ((aiMailPage + 1) * aiMailPageSize >= aiMailTotal);
    }

    async function loadAiMail(doRefresh=false){
      const table = $('#ai-mail-table');
      const empty = $('#ai-mail-empty');
      const pager = $('#ai-mail-pager');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      if (pager) pager.style.display = 'none';

      try {
        const agentSel = $('#aiMailAgentFilter');
        const agentId = agentSel ? String(agentSel.value || '').trim() : '';
        const url = `/api/me/ai/mail?page=${aiMailPage}&pageSize=${aiMailPageSize}`
          + (agentId ? `&agent_id=${encodeURIComponent(agentId)}` : '')
          + (doRefresh ? `&refresh=1` : '');

        const r = await fetch(url);
        const j = await r.json();
        if (!j || j.success === false) {
          aiMailData = [];
          aiMailTotal = 0;
          renderAiMail();
          if (empty) empty.textContent = j?.message || 'Failed to load mail';
          return;
        }

        aiMailData = Array.isArray(j.data) ? j.data : [];
        const total = Number(j.total);
        aiMailTotal = Number.isFinite(total) ? total : aiMailData.length;

        if (aiMailTotal > 0 && aiMailPage > 0 && aiMailPage * aiMailPageSize >= aiMailTotal) {
          aiMailPage = 0;
          return loadAiMail(doRefresh);
        }

        renderAiMail();
      } catch (e) {
        aiMailData = [];
        aiMailTotal = 0;
        renderAiMail();
        if (empty) empty.textContent = 'Failed to load mail';
      }
    }

    function renderAiConversationSessions(){
      const table = $('#ai-conv-sessions-table');
      const empty = $('#ai-conv-sessions-empty');
      const pager = $('#ai-conv-sessions-pager');
      const pageInfo = $('#aiConvPageInfo');
      const prev = $('#aiConvPrev');
      const next = $('#aiConvNext');
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!aiConvSessionsData || !aiConvSessionsData.length) {
        table.style.display = 'none';
        if (pager) pager.style.display = 'none';
        if (pageInfo) pageInfo.textContent = '';
        empty.style.display = 'block';
        empty.textContent = 'No sessions yet.';
        return;
      }

      for (const s of aiConvSessionsData) {
        const callId = String(s.call_id || '');
        const callDomain = String(s.call_domain || '');
        const start = s.time_start ? fmtDateTime(s.time_start) : '';
        const from = String(s.from_number || '-');
        const agentName = String(s.agent_name || '-');
        const msgCount = (s.message_count != null ? String(s.message_count) : '0');
        const isSelected = aiConvSelected && String(aiConvSelected.call_id || '') === callId && String(aiConvSelected.call_domain || '') === callDomain;

        const tr = document.createElement('tr');
        if (isSelected) tr.style.background = '#eef2ff';
        tr.innerHTML =
          `<td>${escapeHtml(start)}</td>`+
          `<td>${escapeHtml(from)}</td>`+
          `<td>${escapeHtml(agentName)}</td>`+
          `<td>${escapeHtml(msgCount)}</td>`+
          `<td><button type="button" class="ai-conv-open" data-call-id="${escapeHtml(callId)}" data-call-domain="${escapeHtml(callDomain)}">Open</button></td>`;
        tbody.appendChild(tr);
      }

      empty.style.display = 'none';
      table.style.display = 'table';

      const totalPages = aiConvTotal > 0 ? Math.max(1, Math.ceil(aiConvTotal / aiConvPageSize)) : 1;
      if (pageInfo) pageInfo.textContent = `Page ${aiConvPage + 1} of ${totalPages}`;

      if (pager) {
        pager.style.display = (aiConvTotal > aiConvPageSize) ? 'flex' : 'none';
      }
      if (prev) prev.disabled = (aiConvPage <= 0);
      if (next) next.disabled = ((aiConvPage + 1) * aiConvPageSize >= aiConvTotal);
    }

    async function loadAiConversationSessions(){
      const table = $('#ai-conv-sessions-table');
      const empty = $('#ai-conv-sessions-empty');
      const pager = $('#ai-conv-sessions-pager');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      if (pager) pager.style.display = 'none';

      try {
        const agentSel = $('#aiConvAgentFilter');
        const agentId = agentSel ? String(agentSel.value || '').trim() : '';
        const url = `/api/me/ai/conversations/sessions?page=${aiConvPage}&pageSize=${aiConvPageSize}` + (agentId ? `&agent_id=${encodeURIComponent(agentId)}` : '');
        const r = await fetch(url);
        const j = await r.json();
        if (!j || j.success === false) {
          aiConvSessionsData = [];
          aiConvTotal = 0;
          renderAiConversationSessions();
          if (empty) empty.textContent = j?.message || 'Failed to load sessions';
          return;
        }
        aiConvSessionsData = Array.isArray(j.data) ? j.data : [];
        const total = Number(j.total);
        aiConvTotal = Number.isFinite(total) ? total : aiConvSessionsData.length;

        // If current page is out of bounds (e.g. filter changed), jump back and refetch.
        if (aiConvTotal > 0 && aiConvPage > 0 && aiConvPage * aiConvPageSize >= aiConvTotal) {
          aiConvPage = 0;
          return loadAiConversationSessions();
        }

        renderAiConversationSessions();
      } catch (e) {
        aiConvSessionsData = [];
        aiConvTotal = 0;
        renderAiConversationSessions();
        if (empty) empty.textContent = 'Failed to load sessions';
      }
    }

    function renderAiConversationMessages(msgs){
      const box = $('#aiConvMessages');
      const empty = $('#aiConvMessagesEmpty');
      if (!box || !empty) return;

      box.innerHTML = '';

      const arr = Array.isArray(msgs) ? msgs : [];
      if (!arr.length) {
        empty.style.display = 'block';
        empty.textContent = 'No messages recorded for this session.';
        return;
      }

      empty.style.display = 'none';

      for (const m of arr) {
        const role = String(m.role || '');
        const isUser = role === 'user';
        const who = isUser ? 'Caller' : 'AI';
        const ts = m.created_at ? fmtDateTime(m.created_at) : '';

        const card = document.createElement('div');
        card.style.margin = '0 0 10px 0';
        card.style.padding = '8px 10px';
        card.style.border = '1px solid #e5e7eb';
        card.style.borderRadius = '12px';
        card.style.background = isUser ? '#ffffff' : '#f3f4f6';

        const header = document.createElement('div');
        header.style.fontSize = '12px';
        header.style.color = '#6b7280';
        header.style.marginBottom = '4px';
        header.textContent = ts ? `${who} ‚Ä¢ ${ts}` : who;

        const body = document.createElement('div');
        body.style.whiteSpace = 'pre-wrap';
        body.style.fontSize = '13px';
        body.textContent = String(m.content || '');

        card.appendChild(header);
        card.appendChild(body);
        box.appendChild(card);
      }

      box.scrollTop = box.scrollHeight;
    }

    async function loadAiConversationMessages(callDomain, callId){
      const empty = $('#aiConvMessagesEmpty');
      if (empty) {
        empty.style.display = 'block';
        empty.textContent = 'Loading‚Ä¶';
      }
      const box = $('#aiConvMessages');
      if (box) box.innerHTML = '';

      try {
        const url = `/api/me/ai/conversations/messages?call_id=${encodeURIComponent(String(callId || ''))}&call_domain=${encodeURIComponent(String(callDomain || ''))}&limit=5000`;
        const r = await fetch(url);
        const j = await r.json();
        if (!j || j.success === false) {
          if (empty) empty.textContent = j?.message || 'Failed to load messages';
          return;
        }
        renderAiConversationMessages(j.data);
      } catch (e) {
        if (empty) empty.textContent = 'Failed to load messages';
      }
    }

    function selectAiConversationSession(session){
      const callId = String(session && session.call_id ? session.call_id : '');
      const callDomain = String(session && session.call_domain ? session.call_domain : '');
      if (!callId || !callDomain) return;

      aiConvSelected = { call_id: callId, call_domain: callDomain };
      renderAiConversationSessions();

      const meta = $('#aiConvSessionMeta');
      if (meta) {
        const parts = [];
        if (session.from_number) parts.push(`From ${String(session.from_number)}`);
        if (session.time_start) parts.push(fmtDateTime(session.time_start));
        parts.push(`${callDomain}/${callId}`);
        meta.textContent = parts.join(' ‚Ä¢ ');
      }

      loadAiConversationMessages(callDomain, callId);
    }

    function refreshAgentDefaultTemplateSelectOptions(){
      const sel = $('#aiAgentDefaultTemplateSelect');
      if (!sel) return;
      const current = String(sel.value || '');
      sel.innerHTML = '';
      sel.appendChild(new Option('None', ''));
      for (const t of docTemplatesData || []){
        const id = t && t.id != null ? String(t.id) : '';
        const name = t && t.name ? String(t.name) : '';
        if (!id) continue;
        sel.appendChild(new Option(name || id, id));
      }
      // Restore selection if still present
      const still = Array.from(sel.options || []).some(o => String(o.value) === current);
      sel.value = still ? current : '';
    }

    async function loadSmtpSettings(){
      const status = $('#smtpStatus');
      if (status) status.textContent = 'Loading‚Ä¶';
      try {
        const r = await fetch('/api/me/smtp-settings');
        const j = await r.json();
        if (!j || j.success === false) {
          if (status) status.textContent = j?.message || 'Failed to load';
          return;
        }
        const d = j.data;
        smtpHasPassword = !!(d && d.has_password);
        $('#smtpHost').value = d ? (d.host || '') : '';
        $('#smtpPort').value = d ? (d.port || '') : '';
        $('#smtpSecure').checked = !!(d && (d.secure === 1 || d.secure === true));
        $('#smtpUsername').value = d ? (d.username || '') : '';
        $('#smtpPassword').value = '';
        $('#smtpFromEmail').value = d ? (d.from_email || '') : '';
        $('#smtpFromName').value = d ? (d.from_name || '') : '';
        $('#smtpReplyTo').value = d ? (d.reply_to || '') : '';
        if (status) status.textContent = d ? (smtpHasPassword ? 'Configured' : 'Missing password') : 'Not configured';
      } catch (e) {
        if (status) status.textContent = 'Failed to load';
      }
    }

    async function saveSmtpSettings(){
      const btn = $('#saveSmtpBtn');
      if (!btn) return;
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Saving...';
      try {
        const payload = {
          host: ($('#smtpHost').value || '').trim(),
          port: parseInt(String($('#smtpPort').value || '0'), 10),
          secure: $('#smtpSecure').checked ? 1 : 0,
          username: ($('#smtpUsername').value || '').trim(),
          password: ($('#smtpPassword').value || ''),
          from_email: ($('#smtpFromEmail').value || '').trim(),
          from_name: ($('#smtpFromName').value || '').trim(),
          reply_to: ($('#smtpReplyTo').value || '').trim()
        };
        const r = await fetch('/api/me/smtp-settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Failed to save SMTP settings', 'error');
          return;
        }
        showToast('SMTP settings saved.');
        await loadSmtpSettings();
      } catch (e) {
        showToast('Failed to save SMTP settings', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    async function testSmtpSettings(){
      const btn = $('#testSmtpBtn');
      if (!btn) return;
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Sending...';
      try {
        const to_email = ($('#smtpTestToEmail').value || '').trim();
        const r = await fetch('/api/me/smtp-settings/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(to_email ? { to_email } : {})
        });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'SMTP test failed', 'error');
          return;
        }
        showToast('Test email sent.');
      } catch (e) {
        showToast('SMTP test failed', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    async function loadAiTransferSettings(){
      const status = $('#aiTransferStatus');
      if (status) status.textContent = 'Loading‚Ä¶';
      try {
        const r = await fetch('/api/me/ai/transfer-settings');
        const j = await r.json();
        if (!j || j.success === false) {
          if (status) status.textContent = j?.message || 'Failed to load';
          return;
        }
        const d = j.data || {};
        const v = d && d.transfer_to_number ? String(d.transfer_to_number) : '';
        const input = $('#aiTransferNumber');
        if (input) input.value = v;
        if (status) status.textContent = v ? 'Configured' : 'Not configured';
      } catch (e) {
        if (status) status.textContent = 'Failed to load';
      }
    }

    async function saveAiTransferSettings(){
      const btn = $('#saveAiTransferBtn');
      if (!btn) return;
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Saving...';
      try {
        const input = $('#aiTransferNumber');
        const transfer_to_number = input ? String(input.value || '').trim() : '';
        const r = await fetch('/api/me/ai/transfer-settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ transfer_to_number })
        });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Failed to save transfer settings', 'error');
          return;
        }
        showToast('Transfer settings saved.');
        await loadAiTransferSettings();
      } catch (e) {
        showToast('Failed to save transfer settings', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    // AI Mail settings (return address)
    async function loadMailSettings(){
      const status = $('#mailSettingsStatus');
      if (status) status.textContent = 'Loading‚Ä¶';
      try {
        const r = await fetch('/api/me/ai/mail-settings');
        const j = await r.json();
        if (!j || j.success === false) {
          if (status) status.textContent = j?.message || 'Failed to load';
          return;
        }
        const d = j.data || null;
        $('#mailFromName').value = d ? (d.name || '') : '';
        $('#mailFromOrg').value = d ? (d.organization || '') : '';
        $('#mailFromAddress1').value = d ? (d.address1 || '') : '';
        $('#mailFromAddress2').value = d ? (d.address2 || '') : '';
        $('#mailFromCity').value = d ? (d.city || '') : '';
        $('#mailFromState').value = d ? (d.state || '') : '';
        $('#mailFromPostal').value = d ? (d.postal_code || '') : '';
        try { $('#mailFromCountry').value = d ? (d.country || 'US') : 'US'; } catch {}
        if (status) status.textContent = d ? 'Configured' : 'Not configured';
      } catch (e) {
        if (status) status.textContent = 'Failed to load';
      }
    }

    async function saveMailSettings(){
      const btn = $('#saveMailSettingsBtn');
      if (!btn) return;
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Saving...';
      try {
        const payload = {
          name: ($('#mailFromName').value || '').trim(),
          organization: ($('#mailFromOrg').value || '').trim(),
          address1: ($('#mailFromAddress1').value || '').trim(),
          address2: ($('#mailFromAddress2').value || '').trim(),
          city: ($('#mailFromCity').value || '').trim(),
          state: ($('#mailFromState').value || '').trim(),
          postal_code: ($('#mailFromPostal').value || '').trim(),
          country: ($('#mailFromCountry').value || 'US').trim()
        };
        const r = await fetch('/api/me/ai/mail-settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Failed to save mail settings', 'error');
          return;
        }
        showToast('Mail settings saved.');
        await loadMailSettings();
      } catch (e) {
        showToast('Failed to save mail settings', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    function renderDocTemplates(){
      const table = $('#ai-doc-templates-table');
      const empty = $('#ai-doc-templates-empty');
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!docTemplatesData || !docTemplatesData.length){
        table.style.display = 'none';
        empty.style.display = 'block';
        empty.textContent = 'No templates yet. Upload a .docx.';
        refreshAgentDefaultTemplateSelectOptions();
        return;
      }

      for (const t of docTemplatesData){
        const tr = document.createElement('tr');
        const name = String(t.name || '');
        const file = String(t.original_filename || '');
        const updated = t.updated_at ? new Date(t.updated_at).toLocaleString() : '';
        tr.innerHTML =
          `<td>${escapeHtml(name)}</td>`+
          `<td>${escapeHtml(file)}</td>`+
          `<td>${escapeHtml(updated)}</td>`+
          `<td><button class="ai-doc-template-delete" data-id="${escapeHtml(String(t.id))}" style="background:#ef4444">Delete</button></td>`;
        tbody.appendChild(tr);
      }

      empty.style.display = 'none';
      table.style.display = 'table';
      refreshAgentDefaultTemplateSelectOptions();
    }

    async function loadDocTemplates(){
      const table = $('#ai-doc-templates-table');
      const empty = $('#ai-doc-templates-empty');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      try {
        const r = await fetch('/api/me/ai/doc-templates');
        const j = await r.json();
        if (!j || j.success === false) {
          docTemplatesData = [];
          renderDocTemplates();
          if (empty) empty.textContent = j?.message || 'Failed to load templates';
          return;
        }
        docTemplatesData = Array.isArray(j.data) ? j.data : [];
        renderDocTemplates();
      } catch (e) {
        docTemplatesData = [];
        renderDocTemplates();
        if (empty) empty.textContent = 'Failed to load templates';
      }
    }

    function getSelectedCartesiaVoiceId(){
      const sel = $('#aiAgentCartesiaVoiceSelect');
      const custom = $('#aiAgentCartesiaVoiceCustom');
      if (!sel) return '';
      const v = String(sel.value || '');
      if (v === '__custom__') return String(custom && custom.value ? custom.value : '').trim();
      return v.trim();
    }

    function setCartesiaCustomVisible(on){
      const wrap = $('#aiAgentCartesiaVoiceCustomWrap');
      if (!wrap) return;
      wrap.style.display = on ? 'block' : 'none';
    }

    function applyAiVoiceSelection(voiceId){
      const sel = $('#aiAgentCartesiaVoiceSelect');
      const custom = $('#aiAgentCartesiaVoiceCustom');
      if (!sel) return;
      const id = String(voiceId || '').trim();

      if (!id) {
        sel.value = '';
        if (custom) custom.value = '';
        setCartesiaCustomVisible(false);
        return;
      }

      const found = Array.from(sel.options || []).some(o => String(o.value) === id);
      if (found) {
        sel.value = id;
        if (custom) custom.value = '';
        setCartesiaCustomVisible(false);
      } else {
        sel.value = '__custom__';
        if (custom) custom.value = id;
        setCartesiaCustomVisible(true);
      }
    }

    async function loadCartesiaVoices(force=false){
      if (cartesiaVoicesLoaded && !force) return;
      const sel = $('#aiAgentCartesiaVoiceSelect');
      const btn = $('#aiLoadVoicesBtn');
      if (!sel || !btn) return;

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Loading...';
      try {
        const r = await fetch('/api/me/ai/cartesia/voices?limit=200');
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Failed to load Cartesia voices', 'error');
          return;
        }
        const voices = Array.isArray(j.data) ? j.data : [];

        // Preserve current selection before rebuilding options
        const currentId = getSelectedCartesiaVoiceId();

        sel.innerHTML = '';
        sel.appendChild(new Option('Default voice', ''));
        sel.appendChild(new Option('Custom voice id‚Ä¶', '__custom__'));

        for (const v of voices){
          const id = v && v.id ? String(v.id) : '';
          if (!id) continue;
          const name = String(v.name || '').trim();
          const lang = String(v.language || '').trim();
          const label = (name ? name : id) + (lang ? ` (${lang})` : '');
          sel.appendChild(new Option(label, id));
        }

        cartesiaVoicesLoaded = true;
        applyAiVoiceSelection(currentId);
      } catch (e) {
        showToast('Failed to load Cartesia voices', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    function renderAiAgents(){
      const table = $('#ai-agents-table');
      const empty = $('#ai-agents-empty');
      const count = $('#aiAgentsCount');
      if (count) count.textContent = `(${aiAgentsData.length}/5)`;
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!aiAgentsData.length){
        table.style.display = 'none';
        empty.style.display = 'block';
        empty.textContent = 'No agents yet. Click ‚ÄúCreate Agent‚Äù.';
        return;
      }

      for (const a of aiAgentsData){
        const greeting = String(a.greeting || '');
        const greetShort = greeting.length > 44 ? (greeting.slice(0,44) + '‚Ä¶') : greeting;
        const voiceId = String(a.cartesia_voice_id || '');
        const voiceShort = voiceId ? (voiceId.length > 18 ? (voiceId.slice(0,18) + '‚Ä¶') : voiceId) : '-';
        const num = a.phone_number || '';
        const tr = document.createElement('tr');
        tr.innerHTML =
          `<td>${escapeHtml(a.display_name || '')}</td>`+
          `<td title="${escapeHtml(voiceId)}">${escapeHtml(voiceShort)}</td>`+
          `<td>${escapeHtml(greetShort)}</td>`+
          `<td>${escapeHtml(num || '-')}</td>`+
          `<td>`+
            `<button class="edit-ai-agent" data-id="${escapeHtml(String(a.id))}">Edit</button> `+
            `<button class="redeploy-ai-agent" data-id="${escapeHtml(String(a.id))}" style="background:#f59e0b">Redeploy</button> `+
            `<button class="del-ai-agent" data-id="${escapeHtml(String(a.id))}" style="background:#ef4444">Delete</button>`+
          `</td>`;
        tbody.appendChild(tr);
      }

      empty.style.display = 'none';
      table.style.display = 'table';
    }

    function renderAiNumbers(){
      const table = $('#ai-numbers-table');
      const empty = $('#ai-numbers-empty');
      const count = $('#aiNumbersCount');
      if (count) count.textContent = `(${aiNumbersData.length}/5)`;
      if (!table || !empty) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!aiNumbersData.length){
        table.style.display = 'none';
        empty.style.display = 'block';
        empty.textContent = 'No phone numbers yet. Click ‚ÄúBuy Number‚Äù.';
        return;
      }

      const agentOptions = ['<option value="">-- Unassigned --</option>']
        .concat(aiAgentsData.map(a => `<option value="${escapeHtml(String(a.id))}">${escapeHtml(a.display_name || '')}</option>`))
        .join('');

      for (const n of aiNumbersData){
        const tr = document.createElement('tr');
        const unassignBtn = n.agent_id
          ? `<button class="ai-number-unassign" data-number-id="${escapeHtml(String(n.id))}" style="background:#6b7280">Unassign</button>`
          : '';
        tr.innerHTML =
          `<td>${escapeHtml(n.phone_number || '')}</td>`+
          `<td><select class="ai-number-agent-select" data-number-id="${escapeHtml(String(n.id))}" style="width:200px">${agentOptions}</select></td>`+
          `<td>${unassignBtn}</td>`;
        tbody.appendChild(tr);
        const sel = tr.querySelector('select');
        if (sel) sel.value = n.agent_id ? String(n.agent_id) : '';
      }

      empty.style.display = 'none';
      table.style.display = 'table';
    }

    async function loadAiAgents(){
      const empty = $('#ai-agents-empty');
      const table = $('#ai-agents-table');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      try {
        const r = await fetch('/api/me/ai/agents');
        const j = await r.json();
        if (!j || j.success === false) {
          aiAgentsData = [];
          renderAiAgents();
          if (empty) empty.textContent = j?.message || 'Failed to load agents';
          return;
        }
        aiAgentsData = Array.isArray(j.data) ? j.data : [];
        renderAiAgents();
        // agent list impacts number assignment dropdowns
        renderAiNumbers();
      } catch (e) {
        aiAgentsData = [];
        renderAiAgents();
        if (empty) empty.textContent = 'Failed to load agents';
      }
    }

    async function loadAiNumbers(){
      const empty = $('#ai-numbers-empty');
      const table = $('#ai-numbers-table');
      if (empty) { empty.style.display = 'block'; empty.textContent = 'Loading‚Ä¶'; }
      if (table) table.style.display = 'none';
      try {
        const r = await fetch('/api/me/ai/numbers');
        const j = await r.json();
        if (!j || j.success === false) {
          aiNumbersData = [];
          renderAiNumbers();
          if (empty) empty.textContent = j?.message || 'Failed to load numbers';
          return;
        }
        aiNumbersData = Array.isArray(j.data) ? j.data : [];
        renderAiNumbers();
      } catch (e) {
        aiNumbersData = [];
        renderAiNumbers();
        if (empty) empty.textContent = 'Failed to load numbers';
      }
    }

    function openAiAgentModal(agent){
      const modal = $('#aiAgentModal');
      if (!modal) return;
      $('#aiAgentId').value = agent ? String(agent.id) : '';
      $('#aiAgentModalTitle').textContent = agent ? 'ü§ñ Edit AI Agent' : 'ü§ñ Create AI Agent';
      $('#aiAgentName').value = agent ? String(agent.display_name || '') : '';
      $('#aiAgentGreeting').value = agent ? String(agent.greeting || '') : '';
      $('#aiAgentPrompt').value = agent ? String(agent.prompt || '') : '';
      try { $('#aiAgentTransferNumber').value = agent ? String(agent.transfer_to_number || '') : ''; } catch {}

      // Background ambience
      const bgUrl = agent ? String(agent.background_audio_url || '') : '';
      const bgGain = agent && agent.background_audio_gain != null ? String(agent.background_audio_gain) : '';
      const bgUploaded = agent ? Boolean(Number(agent.background_audio_uploaded || 0)) : false;
      const bgUploadName = agent ? String(agent.background_audio_upload_filename || '') : '';
      const bgUploadSize = agent && agent.background_audio_upload_size_bytes != null ? Number(agent.background_audio_upload_size_bytes) : null;

      try { $('#aiAgentBackgroundAudioUrl').value = bgUrl; } catch {}
      try { $('#aiAgentBackgroundAudioGain').value = bgGain || ((bgUrl || bgUploaded) ? '0.06' : ''); } catch {}
      try { $('#aiAgentBackgroundAudioFile').value = ''; } catch {}

      const bgRemoveBtn = $('#aiRemoveBackgroundAudioBtn');
      if (bgRemoveBtn) {
        bgRemoveBtn.style.display = bgUploaded ? 'inline-block' : 'none';
      }

      // Uploaded file status / selection helper text
      const fileLabel = $('#aiAgentBackgroundAudioFileName');
      if (fileLabel) {
        if (bgUploaded) {
          const pieces = [];
          if (bgUploadName) pieces.push(bgUploadName);
          if (bgUploadSize != null && Number.isFinite(bgUploadSize)) {
            pieces.push(`${Math.max(1, Math.round(bgUploadSize / 1024))} KB`);
          }
          fileLabel.textContent = `Uploaded: ${pieces.join(' ‚Ä¢ ') || 'WAV file'}`;
        } else {
          fileLabel.textContent = bgUrl ? 'No file uploaded (using URL).' : 'No file uploaded.';
        }
        fileLabel.dataset.defaultText = fileLabel.textContent;
      }

      // Allow editing URL even when an upload exists (URL acts as fallback)
      try { $('#aiAgentBackgroundAudioUrl').disabled = false; } catch {}

      // Default template selection
      const desiredTemplateId = agent && agent.default_doc_template_id ? String(agent.default_doc_template_id) : '';
      refreshAgentDefaultTemplateSelectOptions();
      try { $('#aiAgentDefaultTemplateSelect').value = desiredTemplateId; } catch {}
      loadDocTemplates().then(() => {
        try { $('#aiAgentDefaultTemplateSelect').value = desiredTemplateId; } catch {}
      });

      // Voice selection
      const desiredVoiceId = agent ? String(agent.cartesia_voice_id || '') : '';
      applyAiVoiceSelection(desiredVoiceId);
      loadCartesiaVoices(false).then(()=>applyAiVoiceSelection(desiredVoiceId));

      modal.style.display = 'flex';
      try { $('#aiAgentName').focus(); } catch {}
    }

    function closeAiAgentModal(){
      const modal = $('#aiAgentModal');
      if (modal) modal.style.display = 'none';
    }

    // AI modal handlers
    $('#createAiAgentBtn').addEventListener('click', () => openAiAgentModal(null));
    $('#cancelAiAgentBtn').addEventListener('click', () => closeAiAgentModal());
    $('#aiAgentModal').addEventListener('click', (e) => { if (e.target === $('#aiAgentModal')) closeAiAgentModal(); });

    // Background audio upload UI
    const bgFileInputEl = $('#aiAgentBackgroundAudioFile');
    if (bgFileInputEl) {
      bgFileInputEl.addEventListener('change', () => {
        const f = bgFileInputEl && bgFileInputEl.files ? bgFileInputEl.files[0] : null;
        const label = $('#aiAgentBackgroundAudioFileName');
        if (!label) return;
        if (f) {
          label.textContent = `Selected: ${String(f.name || 'WAV file')}`;
        } else {
          label.textContent = label.dataset.defaultText || label.textContent;
        }
      });
    }

    // Remove uploaded background audio
    $('#aiRemoveBackgroundAudioBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      const id = ($('#aiAgentId').value || '').trim();
      if (!id) return showToast('Save the agent first.', 'error');
      if (!confirm('Remove uploaded background audio for this agent?')) return;

      const btn = $('#aiRemoveBackgroundAudioBtn');
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Removing...';

      try {
        const r = await fetch(`/api/me/ai/agents/${encodeURIComponent(id)}/background-audio`, { method: 'DELETE' });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Failed to remove background audio', 'error');
          return;
        }
        showToast('Background audio removed.');
        closeAiAgentModal();
        await loadAiAgents();
        await loadAiNumbers();
      } catch (err) {
        showToast('Failed to remove background audio', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    });

    // Voice picker handlers
    $('#aiLoadVoicesBtn').addEventListener('click', () => loadCartesiaVoices(true));
    $('#aiAgentCartesiaVoiceSelect').addEventListener('change', () => {
      const sel = $('#aiAgentCartesiaVoiceSelect');
      const custom = $('#aiAgentCartesiaVoiceCustom');
      const isCustom = sel && sel.value === '__custom__';
      setCartesiaCustomVisible(Boolean(isCustom));
      if (!isCustom && custom) custom.value = '';
    });

    $('#confirmAiAgentBtn').addEventListener('click', async () => {
      const id = ($('#aiAgentId').value || '').trim();
      const display_name = ($('#aiAgentName').value || '').trim();
      const greeting = ($('#aiAgentGreeting').value || '');
      const prompt = ($('#aiAgentPrompt').value || '');
      const cartesia_voice_id = getSelectedCartesiaVoiceId();
      const defaultTpl = ($('#aiAgentDefaultTemplateSelect').value || '').trim();
      const transfer_to_number = ($('#aiAgentTransferNumber').value || '').trim();

      const background_audio_url = ($('#aiAgentBackgroundAudioUrl').value || '').trim();
      const bgGainRaw = ($('#aiAgentBackgroundAudioGain').value || '').trim();
      let background_audio_gain = null;
      if (bgGainRaw) {
        const g = parseFloat(bgGainRaw);
        if (!Number.isFinite(g)) return showToast('Background volume must be a number.', 'error');
        if (g < 0 || g > 0.2) return showToast('Background volume must be between 0.0 and 0.2.', 'error');
        background_audio_gain = g;
      }
      if (background_audio_url && !/^https:\/\//i.test(background_audio_url)) {
        return showToast('Background sound URL must start with https://', 'error');
      }

      if (!display_name) return showToast('Agent name is required.', 'error');

      const btn = $('#confirmAiAgentBtn');
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = id ? 'Saving...' : 'Creating...';

      try {
        const url = id ? `/api/me/ai/agents/${encodeURIComponent(id)}` : '/api/me/ai/agents';
        const method = id ? 'PATCH' : 'POST';
        const r = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            display_name,
            greeting,
            prompt,
            cartesia_voice_id: (cartesia_voice_id || null),
            transfer_to_number,
            default_doc_template_id: defaultTpl ? defaultTpl : null,
            background_audio_url: background_audio_url ? background_audio_url : null,
            background_audio_gain
          })
        });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Failed to save agent', 'error');
          return;
        }

        const savedId = id || (j && j.data && j.data.id != null ? String(j.data.id) : '');
        if (!id && savedId) {
          try { $('#aiAgentId').value = savedId; } catch {}
        }

        // Optional: upload background WAV (replaces any prior upload)
        const bgFileInput = $('#aiAgentBackgroundAudioFile');
        const bgFile = bgFileInput && bgFileInput.files ? bgFileInput.files[0] : null;
        if (bgFile && savedId) {
          if (bgFile.size && bgFile.size > (5 * 1024 * 1024)) {
            showToast('Background WAV must be 5MB or smaller.', 'error');
            return;
          }
          const fd = new FormData();
          fd.append('file', bgFile);
          const ur = await fetch(`/api/me/ai/agents/${encodeURIComponent(savedId)}/background-audio`, { method: 'POST', body: fd });
          const uj = await ur.json();
          if (!uj || uj.success === false) {
            showToast(uj?.message || 'Background audio upload failed', 'error');
            return;
          }
        }

        const msg = (id ? 'Agent updated.' : 'Agent created.') + (bgFile ? ' Background audio uploaded.' : '');
        showToast(msg);
        closeAiAgentModal();
        await loadAiAgents();
        await loadAiNumbers();
      } catch (e) {
        showToast('Failed to save agent', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    });

    // SMTP + templates controls
    $('#saveSmtpBtn').addEventListener('click', (e) => { e.preventDefault(); saveSmtpSettings(); });
    $('#testSmtpBtn').addEventListener('click', (e) => { e.preventDefault(); testSmtpSettings(); });
    $('#saveAiTransferBtn').addEventListener('click', (e) => { e.preventDefault(); saveAiTransferSettings(); });
    $('#saveMailSettingsBtn').addEventListener('click', (e) => { e.preventDefault(); saveMailSettings(); });

    $('#uploadDocTemplateBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      const btn = $('#uploadDocTemplateBtn');
      if (!btn) return;

      const name = ($('#docTemplateName').value || '').trim();
      const fileInput = $('#docTemplateFile');
      const file = fileInput && fileInput.files ? fileInput.files[0] : null;
      if (!file) return showToast('Please choose a .docx file to upload.', 'error');

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Uploading...';
      try {
        const fd = new FormData();
        if (name) fd.append('name', name);
        fd.append('file', file);
        const r = await fetch('/api/me/ai/doc-templates', { method: 'POST', body: fd });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Upload failed', 'error');
          return;
        }
        showToast('Template uploaded.');
        try { $('#docTemplateName').value = ''; } catch {}
        try { $('#docTemplateFile').value = ''; } catch {}
        await loadDocTemplates();
        await loadAiAgents();
      } catch (e2) {
        showToast('Upload failed', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    });

    // Buy number
    $('#buyAiNumberBtn').addEventListener('click', async () => {
      const btn = $('#buyAiNumberBtn');
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Buying...';
      try {
        const r = await fetch('/api/me/ai/numbers/buy', { method: 'POST' });
        const j = await r.json();
        if (!j || j.success === false) {
          showToast(j?.message || 'Failed to buy number', 'error');
          return;
        }
        showToast('Number purchased.');
        await loadAiNumbers();
      } catch (e) {
        showToast('Failed to buy number', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    });

    // Delegated handlers for edit/delete + assign/unassign
    document.addEventListener('click', async (ev) => {
      if (ev.target && ev.target.classList.contains('edit-ai-agent')) {
        const id = ev.target.getAttribute('data-id');
        const agent = aiAgentsData.find(a => String(a.id) === String(id));
        openAiAgentModal(agent || null);
      }
      if (ev.target && ev.target.classList.contains('redeploy-ai-agent')) {
        const btn = ev.target;
        const id = btn.getAttribute('data-id');
        if (!id) return;
        if (!confirm('Redeploy this agent now? This will restart the agent service and may interrupt active calls.')) return;

        btn.disabled = true;
        const old = btn.textContent;
        btn.textContent = 'Redeploying...';

        try {
          const r = await fetch(`/api/me/ai/agents/${encodeURIComponent(id)}/redeploy`, { method: 'POST' });
          const j = await r.json().catch(() => null);
          if (!r.ok || !j || j.success === false) {
            showToast(j?.message || 'Failed to redeploy agent', 'error');
            return;
          }
          showToast('Agent redeployed.');
          await loadAiAgents();
          await loadAiNumbers();
        } catch {
          showToast('Failed to redeploy agent', 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = old;
        }
      }
      if (ev.target && ev.target.classList.contains('del-ai-agent')) {
        const id = ev.target.getAttribute('data-id');
        if (!confirm('Delete this agent?')) return;
        try {
          const r = await fetch(`/api/me/ai/agents/${encodeURIComponent(id)}`, { method: 'DELETE' });
          const j = await r.json();
          if (!j || j.success === false) {
            showToast(j?.message || 'Failed to delete agent', 'error');
            return;
          }
          showToast('Agent deleted.');
          await loadAiAgents();
          await loadAiNumbers();
        } catch {
          showToast('Failed to delete agent', 'error');
        }
      }
      if (ev.target && ev.target.classList.contains('ai-number-unassign')) {
        const numberId = ev.target.getAttribute('data-number-id');
        try {
          const r = await fetch(`/api/me/ai/numbers/${encodeURIComponent(numberId)}/unassign`, { method: 'POST' });
          const j = await r.json();
          if (!j || j.success === false) {
            showToast(j?.message || 'Failed to unassign number', 'error');
            return;
          }
          showToast('Number unassigned.');
          await loadAiAgents();
          await loadAiNumbers();
        } catch {
          showToast('Failed to unassign number', 'error');
        }
      }
      if (ev.target && ev.target.classList.contains('ai-doc-template-delete')) {
        const tplId = ev.target.getAttribute('data-id');
        if (!tplId) return;
        if (!confirm('Delete this document template?')) return;
        try {
          const r = await fetch(`/api/me/ai/doc-templates/${encodeURIComponent(tplId)}`, { method: 'DELETE' });
          const j = await r.json();
          if (!j || j.success === false) {
            showToast(j?.message || 'Delete failed', 'error');
            return;
          }
          showToast('Template deleted.');
          await loadDocTemplates();
          await loadAiAgents();
        } catch {
          showToast('Delete failed', 'error');
        }
      }
    });

    document.addEventListener('change', async (ev) => {
      if (!ev.target || !ev.target.classList.contains('ai-number-agent-select')) return;
      const select = ev.target;
      const numberId = select.getAttribute('data-number-id');
      const agentId = select.value;

      select.disabled = true;
      try {
        if (!agentId) {
          const r = await fetch(`/api/me/ai/numbers/${encodeURIComponent(numberId)}/unassign`, { method: 'POST' });
          const j = await r.json();
          if (!j || j.success === false) {
            showToast(j?.message || 'Failed to unassign number', 'error');
            await loadAiNumbers();
            return;
          }
          showToast('Number unassigned.');
        } else {
          const r = await fetch(`/api/me/ai/numbers/${encodeURIComponent(numberId)}/assign`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ agent_id: agentId })
          });
          const j = await r.json();
          if (!j || j.success === false) {
            showToast(j?.message || 'Failed to assign number', 'error');
            await loadAiNumbers();
            return;
          }
          showToast('Number assigned.');
        }
        await loadAiAgents();
        await loadAiNumbers();
      } catch (e) {
        showToast('Failed to update assignment', 'error');
        await loadAiNumbers();
      } finally {
        select.disabled = false;
      }
    });

    let callsChart = null;
    async function loadStats(){
      try{
        const fromInput = document.getElementById('from');
        const toInput = document.getElementById('to');
        let from = fromInput && fromInput.value;
        let to = toInput && toInput.value;
        if (!from || !to){
          const rng = defaultRange();
          from = rng.from; to = rng.to;
        }
        const q = new URLSearchParams();
        q.set('from', from);
        q.set('to', to);
        const r = await fetch('/api/me/stats?'+q.toString());
        const j = await r.json();
        if (!j || j.success === false) return;
        const k = j.kpis || {};
        const range = j.range || {};
        const elTotalDids = document.getElementById('kpiTotalDids');
        const elTotalDidsSub = document.getElementById('kpiTotalDidsSub');
        const elInbound = document.getElementById('kpiInbound');
        const elOutbound = document.getElementById('kpiOutbound');
        const elInboundToday = document.getElementById('kpiInboundToday');
        const elOutboundToday = document.getElementById('kpiOutboundToday');
        const elSipTotal = document.getElementById('kpiSipTotal');
        const elSipOnline = document.getElementById('kpiSipOnline');
        const elAiAgents = document.getElementById('kpiAiAgents');
        const elAiEmailsSent = document.getElementById('kpiAiEmailsSent');
        const elAiMeetingLinksSent = document.getElementById('kpiAiMeetingLinksSent');
        const elAiPhysicalMailSent = document.getElementById('kpiAiPhysicalMailSent');
        const elAiMeetingMailTotal = document.getElementById('kpiAiMeetingMailTotal');
        const elRange = document.getElementById('statsRangeText');
        if (elTotalDids) elTotalDids.textContent = (k.totalDids != null ? String(k.totalDids) : '‚Äì');
        if (elTotalDidsSub) {
          const didww = (k.didwwDidCount != null ? Number(k.didwwDidCount) : null);
          const ai = (k.aiDidCount != null ? Number(k.aiDidCount) : null);
          if (didww != null && ai != null) elTotalDidsSub.textContent = `Standard: ${didww} ‚Ä¢ AI: ${ai}`;
          else if (ai != null) elTotalDidsSub.textContent = `AI: ${ai}`;
          else elTotalDidsSub.textContent = '';
        }
        if (elInbound) elInbound.textContent = (k.inboundCount != null ? String(k.inboundCount) : '‚Äì');
        if (elOutbound) elOutbound.textContent = (k.outboundCount != null ? String(k.outboundCount) : '‚Äì');
        if (elAiAgents) elAiAgents.textContent = (k.aiAgentCount != null ? String(k.aiAgentCount) : '‚Äì');
        if (elAiEmailsSent) elAiEmailsSent.textContent = (k.aiEmailSentCount != null ? String(k.aiEmailSentCount) : '‚Äì');

        if (elAiMeetingLinksSent) elAiMeetingLinksSent.textContent = (k.aiMeetingLinkSentCount != null ? String(k.aiMeetingLinkSentCount) : '‚Äì');
        if (elAiPhysicalMailSent) elAiPhysicalMailSent.textContent = (k.aiPhysicalMailSentCount != null ? String(k.aiPhysicalMailSentCount) : '‚Äì');
        if (elAiMeetingMailTotal) {
          const m = (k.aiMeetingLinkSentCount != null ? Number(k.aiMeetingLinkSentCount) : null);
          const p = (k.aiPhysicalMailSentCount != null ? Number(k.aiPhysicalMailSentCount) : null);
          const hasM = Number.isFinite(m);
          const hasP = Number.isFinite(p);
          if (!hasM && !hasP) {
            elAiMeetingMailTotal.textContent = '‚Äì';
          } else {
            elAiMeetingMailTotal.textContent = String((hasM ? m : 0) + (hasP ? p : 0));
          }
        }
        if (elInboundToday) {
          if (k.inboundToday != null) elInboundToday.textContent = `Today: ${k.inboundToday}`;
          else elInboundToday.textContent = '';
        }
        if (elOutboundToday) {
          if (k.outboundToday != null) elOutboundToday.textContent = `Today: ${k.outboundToday}`;
          else elOutboundToday.textContent = '';
        }
        if (elSipTotal) elSipTotal.textContent = (k.totalSip != null ? String(k.totalSip) : '‚Äì');
        if (elSipOnline){
          if (k.totalSip != null && k.onlineSip != null){
            elSipOnline.textContent = `${k.onlineSip} online`;
          } else {
            elSipOnline.textContent = '';
          }
        }
        if (elRange && range.from && range.to){
          elRange.textContent = `Calls from ${range.from} to ${range.to}`;
        }
        const series = j.series || {};
        const byDay = Array.isArray(series.callsByDay) ? series.callsByDay : [];
        const labels = byDay.map(p=>p.date);
        const inboundData = byDay.map(p=>Number(p.inbound||0));
        const outboundData = byDay.map(p=>Number(p.outbound||0));
        const canvas = document.getElementById('callsChart');
        if (!canvas || !window.Chart) return;
        const ctx = canvas.getContext('2d');
        if (!callsChart){
          callsChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [
                { label: 'Inbound', data: inboundData, backgroundColor: 'rgba(34,197,94,0.7)' },
                { label: 'Outbound', data: outboundData, backgroundColor: 'rgba(59,130,246,0.7)' }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { stacked: false },
                y: { beginAtZero: true, ticks: { precision: 0 } }
              },
              plugins: { legend: { position: 'bottom' } }
            }
          });
        } else {
          callsChart.data.labels = labels;
          if (callsChart.data.datasets[0]) callsChart.data.datasets[0].data = inboundData;
          if (callsChart.data.datasets[1]) callsChart.data.datasets[1].data = outboundData;
          callsChart.update();
        }
      }catch(e){
        console.error('[loadStats]', e);
      }
    }

    async function loadProfile(){
      try{
        const r = await fetch('/api/me/profile'); const j = await r.json();
        const d = j?.data || {};
        if (j.success){
          const body = $('#profile-table tbody'); body.innerHTML = '';
          const balanceDisplay = d.balance !== null && d.balance !== undefined ? `$${Number(d.balance).toFixed(2)}` : 'Loading...';
          // Update header balance if element exists
          if (d.balance !== null && d.balance !== undefined && $('#currentBalance')) {
$('#currentBalance').innerHTML = `Current Balance: <strong style=\"color:#facc15\">$${Number(d.balance).toFixed(2)}</strong>`;
          }
          const callLimitDisplay = d.callLimit !== null && d.callLimit !== undefined ? String(d.callLimit) : '0';
          const cpsLimitDisplay = d.cpsLimit !== null && d.cpsLimit !== undefined ? String(d.cpsLimit) : '0';
          const fields = [
            ['Name', d.name||''],
            ['Email', d.email||''],
            ['Phone', d.phone||''],
            ['Username', d.username||''],
            ['Street Address', d.address1||''],
            ['City', d.city||''],
            ['State / Province', d.state||''],
            ['ZIP / Postal Code', d.postalCode||''],
            ['Country', d.country||''],
            ['Signup IP', d.signupIp||''],
            ['SIP Domain', d.sipDomain||new URL(location.href).hostname],
            ['Balance', balanceDisplay],
            ['Channel Limit', callLimitDisplay],
            ['CPS Limit', cpsLimitDisplay]
          ];
          for (const [k,v] of fields){
            const tr=document.createElement('tr');
            tr.innerHTML = `<th>${escapeHtml(k)}</th><td>${escapeHtml(String(v||''))}</td>`;
            body.appendChild(tr);
          }
          $('#profile-empty').style.display='none'; $('#profile-table').style.display='table';
        } else { $('#profile-empty').textContent='No profile'; }
      }catch{ $('#profile-empty').textContent='Failed to load profile'; }
    }
    let sipPage = 0; const sipPageSize = 20;
    let sipSearchQuery = '';
    let allSipData = []; // Cache SIP data for current page (used for search within the page)
    let sipTotal = 0;    // Total SIP accounts for this user (from server)
    
    async function loadSip(){
      try{
        const r = await fetch(`/api/me/sip-users?page=${sipPage}&pageSize=${sipPageSize}`);
        const j = await r.json();
        console.log('[loadSip] API response:', j);
        const payloadData = j && typeof j === 'object' ? (j.data || {}) : {};
        const rows = grabRows(j);
        console.log('[loadSip] Extracted rows:', rows.length, rows.length > 0 ? rows[0] : null);
        sipTotal = typeof payloadData.total === 'number' ? payloadData.total : rows.length;
        allSipData = rows; // Cache current page rows for search
        renderSipTable(rows);
      }catch(e){ console.error('[loadSip] error:', e); $('#sip-empty').textContent='Failed to load SIP accounts'; }
    }
    
    function renderSipTable(rows) {
      // Apply search filter if query exists
      let filteredRows = rows;
      if (sipSearchQuery) {
        const q = sipSearchQuery.toLowerCase();
        filteredRows = rows.filter(row => {
          const user = (row.username||row.name||row.sipuser||'').toLowerCase();
          const cid = (row.callerid||row.cid||row.calleridname||'').toLowerCase();
          return user.includes(q) || cid.includes(q);
        });
      }
      
      const tbody = $('#sip-table tbody'); tbody.innerHTML='';
      const domain = SIP_DOMAIN || window.location.hostname || '';
      filteredRows.forEach(row=>{
        const id = row.id || row.id_sip || row.idUser || row.id_user || row.idsip;
        const user = row.username||row.name||row.sipuser||''; const cid=row.callerid||row.cid||row.calleridname||'';
        const pwd = row.secret || row.password || '';
        const lineStatus = String(row.lineStatus || row.linestatus || row.status || 'UNKNOWN');
        // Determine status class based on lineStatus
        let statusClass = 'status-unknown', statusText = 'Unknown';
        if (lineStatus.toUpperCase().startsWith('OK')) {
          statusClass = 'status-ok'; statusText = 'Online';
        } else if (lineStatus.toUpperCase().includes('UNREACHABLE')) {
          statusClass = 'status-unreachable'; statusText = 'Offline';
        }
        const masked = pwd ? '‚Ä¢'.repeat(Math.min(10, String(pwd).length)) : '';
        const userCell = `${escapeHtml(user)} <button class=\"icon-btn copy\" data-val=\"${escapeHtml(user)}\" title=\"Copy username\">üìã</button>`;
        const passCell = `<span class=\"sip-pass\" data-pass=\"${escapeHtml(pwd)}\" data-visible=\"0\">${escapeHtml(masked)}</span> `+
                         `<button class=\"icon-btn sip-pass-toggle\" title=\"Show password\">üëÅ</button>`+
                         `<button class=\"icon-btn copy\" data-val=\"${escapeHtml(pwd)}\" title=\"Copy password\">üìã</button>`;
        const domainCell = `<span class=\"sip-domain-text\">${escapeHtml(domain)}</span> `+
                           `<button class=\"icon-btn copy\" data-val=\"${escapeHtml(domain)}\" title=\"Copy domain\">üìã</button>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><span class=\"status-indicator ${statusClass}\" title=\"${escapeHtml(lineStatus)}\"></span>${escapeHtml(statusText)}</td>`+
                       `<td>${userCell}</td>`+
                       `<td>${passCell}</td>`+
                       `<td>${domainCell}</td>`+
                       `<td><input data-id=\"${escapeHtml(String(id||''))}\" class=\"cid-input\" value=\"${escapeHtml(cid)}\"></td>`+
                       `<td><span class=\"direction-icon\" title=\"Inbound & Outbound calls enabled\">‚Üï</span></td>`+
                       `<td><button data-id=\"${escapeHtml(String(id||''))}\" class=\"save-cid\">Save</button> <button data-id=\"${escapeHtml(String(id||''))}\" class=\"del-sip\">Delete</button></td>`;
        tbody.appendChild(tr);
      });
      if (filteredRows.length){ 
        $('#sip-empty').style.display='none'; 
        $('#sip-table').style.display='table'; 
        $('#sip-pager').style.display='flex'; 
        const rawTotal = sipSearchQuery ? filteredRows.length : sipTotal;
        const totalPages = rawTotal > 0 ? Math.ceil(rawTotal / sipPageSize) : 1;
        $('#sipPageInfo').textContent = sipSearchQuery
          ? `${filteredRows.length} result(s)`
          : `Page ${sipPage+1} of ${totalPages}`; 
      } else { 
        $('#sip-table').style.display='none';
        $('#sip-pager').style.display='none';
        $('#sip-empty').style.display='block';
        $('#sip-empty').textContent = sipSearchQuery ? 'No SIP accounts match your search' : 'No SIP accounts yet - click the button above to create one'; 
      }
    }
    
    // SIP Search handlers
    $('#sipSearchBtn').addEventListener('click', () => {
      sipSearchQuery = $('#sipSearch').value.trim();
      renderSipTable(allSipData);
    });
    
    $('#sipClearBtn').addEventListener('click', () => {
      sipSearchQuery = '';
      $('#sipSearch').value = '';
      renderSipTable(allSipData);
    });
    
    // Search on Enter key
    $('#sipSearch').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sipSearchQuery = $('#sipSearch').value.trim();
        renderSipTable(allSipData);
      }
    });
    function defaultRange(){
      const now = new Date();
      const to = now.toISOString().slice(0,10);
      const d7 = new Date(now.getTime()-6*86400000);
      const from = d7.toISOString().slice(0,10);
      return {from,to};
    }
    let cdrPage = 0; const cdrPageSize = 50;
    let cdrMyDids = [];
    
    async function loadCdrDidOptions(){
      try {
        const sel = $('#cdrDid');
        if (!sel) return;
        const r = await fetch('/api/me/dids');
        const j = await r.json();
        if (!j || j.success === false) return;
        const rows = Array.isArray(j.data) ? j.data : [];
        cdrMyDids = rows;
        const current = sel.value;
        sel.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = '';
        optAll.textContent = 'All My Numbers';
        sel.appendChild(optAll);
        rows.forEach(row => {
          const num = row.did_number || row.didNumber || row.number || '';
          if (!num) return;
          const opt = document.createElement('option');
          opt.value = String(num);
          opt.textContent = String(num);
          sel.appendChild(opt);
        });
        if (current && rows.some(row => String(row.did_number || row.didNumber || row.number || '') === current)) {
          sel.value = current;
        }
      } catch (e) {
        console.error('[loadCdrDidOptions]', e);
      }
    }
    
    async function loadCdr(){
      const from = $('#from').value;
      const to = $('#to').value;
      const filter = $('#cdrFilter').value;
      const didSel = $('#cdrDid');
      const did = didSel ? didSel.value : '';

      const q = new URLSearchParams();
      q.set('page', String(cdrPage));
      q.set('pageSize', String(cdrPageSize));
      if (from) q.set('from', from);
      if (to) q.set('to', to);
      if (did) q.set('did', did);

      try{
        let j;

        // Primary: /api/me/cdrs (does its own Magnus‚Üílocal outbound fallback)
        try {
          const r = await fetch('/api/me/cdrs?'+q.toString());
          j = await r.json();
          if (!j || j.success === false) {
            throw new Error('primary CDR fetch failed');
          }
        } catch (primaryErr) {
          // Last-resort: local-only endpoint if primary handler itself errors
          try {
            const r2 = await fetch('/api/me/cdrs/local?'+q.toString());
            const j2 = await r2.json();
            if (!j2 || j2.success === false) {
              throw j2 || primaryErr;
            }
            j = j2;
            console.warn('[loadCdr] Using /api/me/cdrs/local fallback because /api/me/cdrs failed.');
          } catch (fallbackErr) {
            const msg = (j && j.message) || (fallbackErr && fallbackErr.message) || 'Failed to load CDRs';
            $('#cdr-empty').textContent = msg;
            $('#cdr-empty').style.display = 'block';
            $('#cdr-table').style.display = 'none';
            $('#cdr-pager').style.display = 'none';
            return;
          }
        }

        let rows = Array.isArray(j.data) ? j.data : grabRows(j);
        const tbody = $('#cdr-table tbody');
        tbody.innerHTML='';

        // Apply inbound/outbound filter using direction from backend
        if (filter !== 'all') {
          const want = filter === 'inbound' ? 'inbound' : 'outbound';
          rows = rows.filter(c => String(c.direction || '').toLowerCase() === want);
        }

        if (!rows.length) {
          $('#cdr-empty').textContent = filter === 'all'
            ? 'No calls in this range yet.'
            : `No ${filter} calls in this range.`;
          $('#cdr-empty').style.display = 'block';
          $('#cdr-table').style.display = 'none';
          $('#cdr-pager').style.display = 'none';
          return;
        }

        rows.forEach(c => {
          const dir = String(c.direction || 'inbound').toLowerCase();
          const dirIcon = dir === 'outbound'
            ? '<span style="color:#3b82f6" title="Outbound">‚Üë</span>'
            : '<span style="color:#22c55e" title="Inbound">‚Üì</span>';

          const whenIso = c.timeStart || c.createdAt || null;
          const whenStr = whenIso ? new Date(whenIso).toLocaleString() : '';
          const src = c.srcNumber || '';
          const dst = c.dstNumber || c.didNumber || '';
          const durSec = c.billsec != null ? Number(c.billsec) : (c.duration != null ? Number(c.duration) : 0);
          const priceNum = c.price != null ? Number(c.price) : null;
          const priceStr = priceNum != null ? `$${priceNum.toFixed(4)}` : '';
          const statusRaw = (c.status != null ? String(c.status) : '').trim();
          let statusLabel = statusRaw
            ? statusRaw.replace(/_/g, ' ').replace(/(^|\s)\S/g, m => m.toUpperCase())
            : 'Completed';

          // Branding: don't expose internal vendor name ("Pipecat") in customer UI.
          statusLabel = statusLabel.replace(/^Pipecat\b/i, 'AI Agent');

          const tr = document.createElement('tr');
          tr.innerHTML =
            `<td>${dirIcon}</td>`+
            `<td>${escapeHtml(whenStr)}</td>`+
            `<td>${escapeHtml(String(src))}</td>`+
            `<td>${escapeHtml(String(dst))}</td>`+
            `<td>${escapeHtml(String(durSec))}s</td>`+
            `<td>${escapeHtml(priceStr)}</td>`+
            `<td>${escapeHtml(statusLabel)}</td>`;
          tbody.appendChild(tr);
        });

        $('#cdr-empty').style.display='none';
        $('#cdr-table').style.display='table';
        $('#cdr-pager').style.display='flex';

        const total = typeof j.total === 'number' ? j.total : rows.length;
        const totalPages = Math.max(1, Math.ceil(total / cdrPageSize));
        $('#cdrPageInfo').textContent = `Page ${cdrPage+1} of ${totalPages}`;
      }catch(e){
        console.error('[loadCdr]', e);
        $('#cdr-empty').textContent='Failed to load CDRs';
        $('#cdr-empty').style.display='block';
        $('#cdr-table').style.display='none';
        $('#cdr-pager').style.display='none';
      }
    }
    function escapeHtml(s){ return String(s).replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
    function copyBtn(val){ const v = String(val||''); if (!v) return ''; return `<button class=\"copy\" data-val=\"${escapeHtml(v)}\">Copy</button>`; }
    function showToast(msg, type='success'){
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = msg;
      if (type === 'error') toast.style.background = '#ef4444';
      document.body.appendChild(toast);
      setTimeout(()=>{ toast.remove(); }, 3000);
    }
    function showLinkToast(message, linkLabel, linkUrl, type='success'){
      const toast = document.createElement('div');
      toast.className = 'toast';
      if (type === 'error') toast.style.background = '#ef4444';
      const safeMsg = escapeHtml(message || '');
      const safeLabel = escapeHtml(linkLabel || 'Open');
      const href = linkUrl || '#';
      toast.innerHTML = `<div>${safeMsg}</div><div style=\"margin-top:4px;font-size:12px;\"><a href=\"${href}\" target=\"_blank\" rel=\"noopener noreferrer\" style=\"color:#bfdbfe;text-decoration:underline;\">${safeLabel}</a></div>`;
      document.body.appendChild(toast);
      setTimeout(()=>{ toast.remove(); }, 8000);
    }
    function animateButton(btn){
      btn.classList.add('btn-clicked');
      setTimeout(()=>{ btn.classList.remove('btn-clicked'); }, 300);
    }
    // Global button click animation
    document.addEventListener('click', (e)=>{
      if (e.target && e.target.tagName === 'BUTTON') animateButton(e.target);
    });

    // init
    const rng = defaultRange(); $('#from').value = rng.from; $('#to').value = rng.to;
    loadProfile(); loadSip(); loadCdrDidOptions(); loadCdr(); loadStats();

    // If redirected back from NOWPayments with ?payment=success or ?payment=cancel, handle it
    (function handlePaymentReturn() {
      try {
        const params = new URLSearchParams(window.location.search || '');
        const paymentStatus = params.get('payment');
        const method = (params.get('method') || '').toLowerCase();
        if (!paymentStatus) return;

        if (paymentStatus === 'success') {
          // Switch to Billing tab and refresh
          activate('billing');
          billingPage = 0;
          loadBillingHistory();
          loadProfile();
          const label = method === 'crypto' ? 'Crypto payment' : method === 'card' ? 'Card payment' : 'Payment';
          showToast(`${label} received! Your balance has been updated or will be shortly.`);
        } else if (paymentStatus === 'cancel') {
          const cancelLabel = method === 'crypto' ? 'Crypto payment was cancelled. No funds were added.' :
                             method === 'card' ? 'Card payment was cancelled. No funds were added.' :
                             'Payment was cancelled. No funds were added.';
          showToast(cancelLabel, 'error');
        }

        // Clean up URL so the message does not repeat on refresh
        if (window.history && window.history.replaceState) {
          const url = new URL(window.location.href);
          url.searchParams.delete('payment');
          url.searchParams.delete('method');
          window.history.replaceState({}, document.title, url.toString());
        }
      } catch (e) {
        console.error('[paymentReturn]', e);
      }
    })();
    $('#loadCdr').addEventListener('click', e=>{ e.preventDefault(); cdrPage=0; loadCdr(); loadStats(); });
    document.getElementById('cdrPrev').addEventListener('click', ()=>{ if (cdrPage>0) { cdrPage--; loadCdr(); } });
    document.getElementById('cdrNext').addEventListener('click', ()=>{ cdrPage++; loadCdr(); });
    document.getElementById('sipPrev').addEventListener('click', ()=>{ if (sipPage>0){ sipPage--; loadSip(); } });
    document.getElementById('sipNext').addEventListener('click', ()=>{
      const totalPages = sipTotal > 0 ? Math.ceil(sipTotal / sipPageSize) : 1;
      if ((sipPage + 1) < totalPages) {
        sipPage++;
        loadSip();
      }
    });
    
    // SIP Modal handlers
    $('#createSipBtn').addEventListener('click', () => {
      $('#sipModal').style.display = 'flex';
      $('#newSipUser').value = '';
      $('#newSipPass').value = '';
      $('#newSipCID').value = '';
      $('#newSipUser').focus();
    });
    
    $('#cancelSipBtn').addEventListener('click', () => {
      $('#sipModal').style.display = 'none';
    });
    
    $('#sipModal').addEventListener('click', (e) => {
      if (e.target === $('#sipModal')) {
        $('#sipModal').style.display = 'none';
      }
    });
    
    $('#confirmSipBtn').addEventListener('click', async ()=>{
      const sipUser=$('#newSipUser').value.trim(); const password=$('#newSipPass').value; const callerid=$('#newSipCID').value.trim();
      if (!sipUser || !password) return alert('SIP username and password required');
      if (!/^\d{11}$/.test(callerid)) return alert('CallerID must be numbers only, exactly 11 digits');
      
      $('#confirmSipBtn').disabled = true;
      $('#confirmSipBtn').textContent = 'Creating...';
      
      // Check availability before creating
      try {
        const a = await fetch(`/api/me/sip-users/availability?sipUser=${encodeURIComponent(sipUser)}`);
        const aj = await a.json();
        if (!aj.success) { alert(aj.message||'Availability check failed'); return; }
        if (!aj.available) { alert('SIP username already exists. Choose another.'); return; }
      } catch (e) { alert('Availability check failed'); return; } finally {
        $('#confirmSipBtn').disabled = false;
        $('#confirmSipBtn').textContent = 'Create Account';
      }
      
      $('#confirmSipBtn').disabled = true;
      $('#confirmSipBtn').textContent = 'Creating...';
      
      try {
        const r = await fetch('/api/me/sip-users', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sipUser, password, callerid }) });
        const j = await r.json(); 
        if (!j.success) { alert(j.message||'Create failed'); return; }
        showToast(`SIP account "${sipUser}" created successfully!`);
        $('#sipModal').style.display = 'none';
        loadSip(); loadProfile();
      } catch (e) {
        alert('Failed to create SIP account');
      } finally {
        $('#confirmSipBtn').disabled = false;
        $('#confirmSipBtn').textContent = 'Create Account';
      }
    });
    document.addEventListener('click', async (ev)=>{
      if (ev.target && ev.target.classList.contains('save-cid')){
        const id = ev.target.getAttribute('data-id'); const input = document.querySelector(`input.cid-input[data-id="${CSS.escape(id)}"]`);
        const callerid = input.value.trim();
        if (!/^\d{11}$/.test(callerid)) { alert('CallerID must be numbers only, exactly 11 digits'); return; }
        const r = await fetch(`/api/me/sip-users/${encodeURIComponent(id)}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ callerid }) });
        const j = await r.json(); 
        if (!j.success) return alert(j.message||'Update failed');
        showToast('CallerID updated successfully!');
        loadSip();
      } else if (ev.target && ev.target.classList.contains('del-sip')){
        const id = ev.target.getAttribute('data-id'); if (!confirm('Delete this SIP account?')) return;
        const r = await fetch(`/api/me/sip-users/${encodeURIComponent(id)}`, { method:'DELETE' }); 
        const j = await r.json(); 
        if (!j.success) return alert(j.message||'Delete failed');
        showToast('SIP account deleted successfully!');
        loadSip();
      } else if (ev.target && ev.target.classList.contains('copy')){
        const v = ev.target.getAttribute('data-val')||''; try { await navigator.clipboard.writeText(v); } catch {}
      } else if (ev.target && ev.target.classList.contains('sip-pass-toggle')) {
        const btn = ev.target;
        const cell = btn.closest('td');
        const span = cell ? cell.querySelector('.sip-pass') : null;
        if (!span) return;
        const isVisible = span.getAttribute('data-visible') === '1';
        const full = span.getAttribute('data-pass') || '';
        if (isVisible) {
          span.textContent = full ? '‚Ä¢'.repeat(Math.min(10, full.length)) : '';
          span.setAttribute('data-visible','0');
          btn.textContent = 'üëÅ';
          btn.title = 'Show password';
        } else {
          span.textContent = full;
          span.setAttribute('data-visible','1');
          btn.textContent = 'üôà';
          btn.title = 'Hide password';
        }
      }
    });

    // Trunk Management
    let trunksData = [];
    let trunkPage = 0; const trunkPageSize = 10;
    let trunkSearchQuery = '';
    
    async function loadTrunks() {
      try {
        const r = await fetch('/api/me/didww/trunks');
        const j = await r.json();
        
        if (!j.success) {
          $('#trunk-empty').textContent = j.message || 'Failed to load trunks';
          return;
        }
        trunksData = j.data || [];
        renderTrunksTable();
      } catch (e) {
        console.error('[loadTrunks] error:', e);
        $('#trunk-empty').textContent = 'Failed to load trunks';
        $('#trunk-empty').style.display = 'block';
        $('#trunk-table').style.display = 'none';
        $('#trunk-pager').style.display = 'none';
      }
    }
    
    function renderTrunksTable() {
      // Apply search filter
      let filteredData = trunksData;
      if (trunkSearchQuery) {
        const q = trunkSearchQuery.toLowerCase();
        filteredData = trunksData.filter(trunk => {
          const attrs = trunk.attributes || {};
          const conf = attrs.configuration?.attributes || attrs.configuration || {};
          const name = (attrs.name || '').toLowerCase();
          const dst = (conf.dst || '').toLowerCase();
          const desc = (attrs.description || '').toLowerCase();
          return name.includes(q) || dst.includes(q) || desc.includes(q);
        });
      }
      
      const tbody = $('#trunk-table tbody');
      tbody.innerHTML = '';
      
      // Paginate
      const start = trunkPage * trunkPageSize;
      const paginated = filteredData.slice(start, start + trunkPageSize);
      const totalPages = Math.ceil(filteredData.length / trunkPageSize) || 1;
      
      if (filteredData.length === 0) {
        $('#trunk-empty').textContent = trunkSearchQuery ? 'No trunks match your search' : 'No trunks created yet - click the button above to create one';
        $('#trunk-empty').style.display = 'block';
        $('#trunk-table').style.display = 'none';
        $('#trunk-pager').style.display = 'none';
      } else {
        $('#trunk-empty').style.display = 'none';
        $('#trunk-table').style.display = 'table';
        $('#trunk-pager').style.display = 'flex';
        $('#trunkPageInfo').textContent = trunkSearchQuery ? `${filteredData.length} result(s)` : `Page ${trunkPage + 1} of ${totalPages}`;
        paginated.forEach(trunk => {
          const attrs = trunk.attributes || {};
          const conf = attrs.configuration?.attributes || attrs.configuration || {};
          const dst = conf.dst || '';
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(attrs.name || '')}</td>`+
                        `<td>${escapeHtml(dst)}</td>`+
                        `<td>${escapeHtml(attrs.description || '')}</td>`+
                        `<td>${escapeHtml(attrs.capacity_limit || 'Unlimited')}</td>`+
                        `<td><button class="edit-trunk" data-id="${escapeHtml(trunk.id)}" data-name="${escapeHtml(attrs.name || '')}" data-dst="${escapeHtml(dst)}" data-desc="${escapeHtml(attrs.description || '')}" data-cap="${escapeHtml(attrs.capacity_limit || '')}">Edit</button> <button class="del-trunk" data-id="${escapeHtml(trunk.id)}">Delete</button></td>`;
          tbody.appendChild(tr);
        });
      }
    }
    
    // Trunk search handlers
    $('#trunkSearchBtn').addEventListener('click', () => {
      trunkSearchQuery = $('#trunkSearch').value.trim();
      trunkPage = 0;
      renderTrunksTable();
    });
    
    $('#trunkClearBtn').addEventListener('click', () => {
      trunkSearchQuery = '';
      $('#trunkSearch').value = '';
      trunkPage = 0;
      renderTrunksTable();
    });
    
    $('#trunkSearch').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        trunkSearchQuery = $('#trunkSearch').value.trim();
        trunkPage = 0;
        renderTrunksTable();
      }
    });
    
    // Trunk pagination
    document.getElementById('trunkPrev').addEventListener('click', () => { if (trunkPage > 0) { trunkPage--; renderTrunksTable(); } });
    document.getElementById('trunkNext').addEventListener('click', () => { 
      const filteredLen = trunkSearchQuery ? trunksData.filter(t => {
        const attrs = t.attributes || {};
        const conf = attrs.configuration?.attributes || attrs.configuration || {};
        const q = trunkSearchQuery.toLowerCase();
        return (attrs.name || '').toLowerCase().includes(q) || (conf.dst || '').toLowerCase().includes(q);
      }).length : trunksData.length;
      if ((trunkPage + 1) * trunkPageSize < filteredLen) { trunkPage++; renderTrunksTable(); }
    });

    // Trunk Modal handlers
    let trunkEditMode = false;
    
    $('#createTrunkBtn').addEventListener('click', () => {
      trunkEditMode = false;
      $('#trunkModalTitle').textContent = '‚Ü™Ô∏è Create Call Forwarding Trunk';
      $('#confirmTrunkBtn').textContent = 'Create Trunk';
      $('#editTrunkId').value = '';
      $('#newTrunkName').value = '';
      $('#newTrunkDst').value = '';
      $('#newTrunkDesc').value = '';
      $('#newTrunkCapacity').value = '';
      $('#trunkModal').style.display = 'flex';
      $('#newTrunkName').focus();
    });
    
    $('#cancelTrunkBtn').addEventListener('click', () => {
      $('#trunkModal').style.display = 'none';
    });
    
    $('#trunkModal').addEventListener('click', (e) => {
      if (e.target === $('#trunkModal')) {
        $('#trunkModal').style.display = 'none';
      }
    });
    
    // Edit trunk - open modal with data
    document.addEventListener('click', async (ev) => {
      if (ev.target && ev.target.classList.contains('edit-trunk')) {
        trunkEditMode = true;
        const btn = ev.target;
        $('#trunkModalTitle').textContent = '‚Ü™Ô∏è Edit Call Forwarding Trunk';
        $('#confirmTrunkBtn').textContent = 'Save Changes';
        $('#editTrunkId').value = btn.getAttribute('data-id');
        $('#newTrunkName').value = btn.getAttribute('data-name') || '';
        $('#newTrunkDst').value = btn.getAttribute('data-dst') || '';
        $('#newTrunkDesc').value = btn.getAttribute('data-desc') || '';
        $('#newTrunkCapacity').value = btn.getAttribute('data-cap') || '';
        $('#trunkModal').style.display = 'flex';
        $('#newTrunkName').focus();
      }
    });
    
    // Create or update trunk
    $('#confirmTrunkBtn').addEventListener('click', async () => {
      const name = $('#newTrunkName').value.trim();
      const dst = $('#newTrunkDst').value.trim();
      const description = $('#newTrunkDesc').value.trim();
      const capacity_limit = $('#newTrunkCapacity').value.trim();
      const editId = $('#editTrunkId').value;
      
      if (!name) return alert('Trunk name is required');
      if (!dst) return alert('PSTN destination number is required');
      if (!/^\d{11}$/.test(dst)) return alert('PSTN number must be 11 digits only');
      
      $('#confirmTrunkBtn').disabled = true;
      $('#confirmTrunkBtn').textContent = trunkEditMode ? 'Saving...' : 'Creating...';

      try {
        const payload = { name, dst, description };
        if (capacity_limit) payload.capacity_limit = parseInt(capacity_limit, 10);
        else if (trunkEditMode) payload.capacity_limit = null;
        
        let r;
        if (trunkEditMode && editId) {
          r = await fetch(`/api/me/didww/trunks/${encodeURIComponent(editId)}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } else {
          r = await fetch('/api/me/didww/trunks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        }
        const j = await r.json();
        if (!j.success) { alert(j.message || (trunkEditMode ? 'Update failed' : 'Create trunk failed')); return; }
        showToast(trunkEditMode ? 'Trunk updated successfully!' : `Trunk "${name}" created successfully!`);
        $('#trunkModal').style.display = 'none';
        loadTrunks();
      } catch (e) {
        console.error('[trunk] error:', e);
        alert(trunkEditMode ? 'Failed to update trunk' : 'Failed to create trunk');
      } finally {
        $('#confirmTrunkBtn').disabled = false;
        $('#confirmTrunkBtn').textContent = trunkEditMode ? 'Save Changes' : 'Create Trunk';
      }
    });

    // Delete trunk
    document.addEventListener('click', async (ev) => {
      if (ev.target && ev.target.classList.contains('del-trunk')) {
        const id = ev.target.getAttribute('data-id');
        if (!confirm('Delete this trunk?')) return;
        try {
          const r = await fetch(`/api/me/didww/trunks/${encodeURIComponent(id)}`, { method: 'DELETE' });
          const j = await r.json();
          if (!j.success) return alert(j.message || 'Delete failed');
          showToast('Trunk deleted successfully!');
          loadTrunks();
        } catch (e) {
          console.error('[deleteTrunk] error:', e);
          alert('Failed to delete trunk');
        }
      }
    });


    // ========== Billing History ==========
    let billingData = [];
    
    async function loadBillingHistory() {
      try {
        const r = await fetch(`/api/me/billing-history?page=${billingPage}&pageSize=${billingPageSize}`);
        const j = await r.json();
        billingData = j.data || [];
        const balance = j.balance;
        
        // Update balance display in header if element exists
        if (balance !== undefined && balance !== null && $('#currentBalance')) {
$('#currentBalance').innerHTML = `Current Balance: <strong style=\"color:#facc15\">$${Number(balance).toFixed(2)}</strong>`;
        }
        
        const tbody = $('#billing-table tbody');
        tbody.innerHTML = '';
        
        if (billingData.length === 0) {
          $('#billing-empty').textContent = 'No billing history yet.';
          $('#billing-empty').style.display = 'block';
          $('#billing-table').style.display = 'none';
          $('#billing-pager').style.display = 'none';
          return;
        }
        
        billingData.forEach(row => {
          const tr = document.createElement('tr');
          const date = new Date(row.created_at).toLocaleString();
          const amountNum = Number(row.amount || 0);
          const isNegative = amountNum < 0;
          const amountColor = isNegative ? '#ef4444' : '#059669';
          const amountPrefix = isNegative ? '-$' : '+$';
          // Show more precision for very small charges (e.g. inbound per-second usage)
          let decimals = 2;
          const absAmt = Math.abs(amountNum);
          if (absAmt > 0 && absAmt < 0.01) decimals = 4;
          const amountDisplay = absAmt.toFixed(decimals);
          const rawStatus = (row.status || 'completed').toLowerCase();
          let statusLabel;
          let statusClass;
          if (rawStatus === 'completed') { statusLabel = 'Completed'; statusClass = 'bill-status-completed'; }
          else if (rawStatus === 'pending') { statusLabel = 'Pending confirmation'; statusClass = 'bill-status-pending'; }
          else if (rawStatus === 'failed') { statusLabel = 'Failed'; statusClass = 'bill-status-failed'; }
          else { statusLabel = rawStatus.charAt(0).toUpperCase() + rawStatus.slice(1); statusClass = 'bill-status-pending'; }
          const statusBadge = `<span class=\"bill-status ${statusClass}\">${escapeHtml(statusLabel)}<\/span>`;
          let desc = row.description || 'Account refill';
          let methodBadge = '';
          const lowerDesc = desc.toLowerCase();
          if (lowerDesc.includes('card refill')) {
            methodBadge = '<span class="bill-tag bill-tag-card">Card</span>';
          } else if (lowerDesc.includes('crypto refill')) {
            methodBadge = '<span class="bill-tag bill-tag-crypto">Crypto</span>';
          } else if (lowerDesc.includes('ach refill') || lowerDesc.includes('bill.com refill') || lowerDesc.includes('billcom refill')) {
            methodBadge = '<span class="bill-tag bill-tag-billcom">ACH</span>';
          }
          tr.innerHTML = `<td>${escapeHtml(date)}</td>`+
                        `<td style=\"color:${amountColor};font-weight:600\">${amountPrefix}${escapeHtml(amountDisplay)}</td>`+
                        `<td>${methodBadge}${escapeHtml(desc)}</td>`+
                        `<td>${statusBadge}</td>`;
          tbody.appendChild(tr);
        });
        
        $('#billing-empty').style.display = 'none';
        $('#billing-table').style.display = 'table';
        $('#billing-pager').style.display = 'flex';
        const totalPages = Math.ceil((j.total || billingData.length) / billingPageSize) || 1;
        $('#billingPageInfo').textContent = `Page ${billingPage + 1} of ${totalPages}`;
      } catch (e) {
        console.error('[loadBillingHistory]', e);
        $('#billing-empty').textContent = 'Failed to load billing history';
      }
    }
    
    // Billing pagination
    $('#billingPrev').addEventListener('click', () => { if (billingPage > 0) { billingPage--; loadBillingHistory(); } });
    $('#billingNext').addEventListener('click', () => { billingPage++; loadBillingHistory(); });
    
    // Add Fund Modal
    $('#addFundBtn').addEventListener('click', () => {
      $('#addFundModal').style.display = 'flex';
      $('#fundAmount').value = '';
      $('#fundAmount').focus();
    });
    
    $('#cancelFundBtn').addEventListener('click', () => {
      $('#addFundModal').style.display = 'none';
    });
    
    // Close modal on backdrop click
    $('#addFundModal').addEventListener('click', (e) => {
      if (e.target === $('#addFundModal')) {
        $('#addFundModal').style.display = 'none';
      }
    });
    
    $('#confirmFundBtn').addEventListener('click', async () => {
      const amount = parseFloat($('#fundAmount').value);

      if (!amount || !Number.isFinite(amount)) {
        return alert('Please enter a valid amount.');
      }
      if (amount < CHECKOUT_MIN_AMOUNT || amount > CHECKOUT_MAX_AMOUNT) {
        return alert(`Amount must be between $${CHECKOUT_MIN_AMOUNT.toFixed(2)} and $${CHECKOUT_MAX_AMOUNT.toFixed(2)}.`);
      }

      const methodInput = document.querySelector('input[name="fundMethod"]:checked');
      const method = methodInput ? methodInput.value : 'card';

      $('#confirmFundBtn').disabled = true;
      $('#confirmFundBtn').textContent = method === 'crypto'
        ? 'Redirecting to Crypto...'
        : method === 'billcom'
          ? 'Redirecting to ACH...'
          : 'Redirecting to Card...';

      try {
        const endpoint = method === 'crypto'
          ? '/api/me/nowpayments/checkout'
          : method === 'billcom'
            ? '/api/me/billcom/checkout'
            : '/api/me/card/checkout';
        const r = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount })
        });
        const j = await r.json();

        if (!j.success || !j.payment_url) {
          const label = method === 'crypto'
            ? 'Crypto payment'
            : method === 'billcom'
              ? 'ACH payment'
              : method === 'card'
                ? 'Card payment'
                : 'Payment';
          showToast(j.message || `${label} could not be started. Please try again.`, 'error');
          return;
        }

        // Hide modal and show a toast with a direct link before redirecting
        $('#addFundModal').style.display = 'none';
        const label = method === 'crypto'
          ? 'Crypto payment'
          : method === 'billcom'
            ? 'ACH payment'
            : 'Card payment';
        showLinkToast(`${label} checkout page is ready. If you are not redirected automatically, click the link below.`, 'Open payment page', j.payment_url, 'success');

        // Redirect user to hosted checkout page (Card provider or NOWPayments)
        window.location.href = j.payment_url;
      } catch (e) {
        console.error('[addFunds]', e);
        alert('Failed to start payment. Please try again.');
      } finally {
        $('#confirmFundBtn').disabled = false;
        $('#confirmFundBtn').textContent = 'Continue';
      }
    });

    // ========== Buy Numbers ==========
    let countriesData = [], regionsData = [], citiesData = [], didGroupsData = [], availableDidsData = [];
    let currentSkuId = null, currentDidGroupId = null;

    // Toggle toll-free mode - disable region/city when checked
    $('#buyTollfree').addEventListener('change', () => {
      const isTollfree = $('#buyTollfree').checked;
      $('#buyRegion').disabled = isTollfree;
      $('#buyCity').disabled = isTollfree;
      if (isTollfree) {
        $('#buyRegion').innerHTML = '<option value="">N/A for Toll-Free</option>';
        $('#buyCity').innerHTML = '<option value="">N/A for Toll-Free</option>';
      } else {
        $('#buyRegion').innerHTML = '<option value="">Select State/Region...</option>';
        $('#buyCity').innerHTML = '<option value="">Select City...</option>';
        // Reload regions if country selected
        if ($('#buyCountry').value) $('#buyCountry').dispatchEvent(new Event('change'));
      }
    });

    async function loadCountries() {
      try {
        const r = await fetch('/api/me/didww/countries');
        const j = await r.json();
        if (!j.success) return;
        countriesData = j.data || [];
        const sel = $('#buyCountry');
        sel.innerHTML = '<option value="">Select Country...</option>';
        countriesData.forEach(c => {
          const attrs = c.attributes || {};
          sel.innerHTML += `<option value="${c.id}">${escapeHtml(attrs.name || 'Unknown')}</option>`;
        });
      } catch (e) { console.error('[loadCountries]', e); }
    }

    $('#buyCountry').addEventListener('change', async () => {
      const countryId = $('#buyCountry').value;
      const isTollfree = $('#buyTollfree').checked;
      if (isTollfree) return; // Skip region loading for toll-free
      $('#buyRegion').innerHTML = '<option value="">Loading...</option>';
      $('#buyRegion').disabled = true;
      $('#buyCity').innerHTML = '<option value="">Select City...</option>';
      $('#buyCity').disabled = true;
      if (!countryId) return;
      try {
        const r = await fetch(`/api/me/didww/regions?country_id=${countryId}`);
        const j = await r.json();
        regionsData = j.data || [];
        const sel = $('#buyRegion');
        sel.innerHTML = '<option value="">Select State/Region...</option>';
        regionsData.forEach(rg => {
          const attrs = rg.attributes || {};
          sel.innerHTML += `<option value="${rg.id}">${escapeHtml(attrs.name || 'Unknown')}</option>`;
        });
        sel.disabled = false;
      } catch (e) { console.error('[loadRegions]', e); }
    });

    $('#buyRegion').addEventListener('change', async () => {
      const regionId = $('#buyRegion').value;
      $('#buyCity').innerHTML = '<option value="">Loading...</option>';
      $('#buyCity').disabled = true;
      if (!regionId) return;
      try {
        const r = await fetch(`/api/me/didww/cities?region_id=${regionId}`);
        const j = await r.json();
        citiesData = j.data || [];
        const sel = $('#buyCity');
        sel.innerHTML = '<option value="">Select City...</option>';
        citiesData.forEach(ct => {
          const attrs = ct.attributes || {};
          sel.innerHTML += `<option value="${ct.id}">${escapeHtml(attrs.name || 'Unknown')}</option>`;
        });
        sel.disabled = false;
      } catch (e) { console.error('[loadCities]', e); }
    });

    $('#searchDids').addEventListener('click', async () => {
      const cityId = $('#buyCity').value;
      const countryId = $('#buyCountry').value;
      const isTollfree = $('#buyTollfree').checked;
      
      if (!countryId) return alert('Please select a country');
      if (!isTollfree && !cityId && !countryId) return alert('Please select at least a country');
      
      $('#did-groups-info').textContent = 'Searching...';
      $('#available-dids-table').style.display = 'none';
      $('#available-dids-empty').textContent = '';
      
      try {
        // Get DID groups - for toll-free, use different endpoint
        let url;
        if (isTollfree) {
          url = `/api/me/didww/did-groups?country_id=${countryId}&tollfree=1`;
        } else {
          url = '/api/me/didww/did-groups?';
          if (cityId) url += `city_id=${cityId}`;
          else url += `country_id=${countryId}`;
        }
        
        const r = await fetch(url);
        const j = await r.json();
        didGroupsData = j.data || [];
        const included = j.included || [];
        
        if (didGroupsData.length === 0) {
          $('#did-groups-info').textContent = isTollfree ? 'No toll-free numbers available for this country.' : 'No numbers available for this location.';
          return;
        }
        
        // Find first DID group with available SKU
        const didGroup = didGroupsData[0];
        const attrs = didGroup.attributes || {};
        const skuRel = didGroup.relationships?.stock_keeping_units?.data || [];
        const sku = skuRel[0] ? included.find(i => i.type === 'stock_keeping_units' && i.id === skuRel[0].id) : null;
        
        if (!sku) {
          $('#did-groups-info').textContent = 'No pricing available for this location.';
          return;
        }
        
        currentSkuId = sku.id;
        currentDidGroupId = didGroup.id;
        const skuAttrs = sku.attributes || {};
        const typeLabel = isTollfree ? 'üÜì Toll-Free' : 'DID';
        const markupMonthly = isTollfree ? TOLLFREE_DID_MARKUP : LOCAL_DID_MARKUP;
        const markupSetup = 0;
        $('#did-groups-info').innerHTML = `<strong>${escapeHtml(attrs.name || typeLabel)}</strong> - Monthly: $${markupMonthly.toFixed(2)} | Setup: $${markupSetup.toFixed(2)}`;
        
        // Search available DIDs
        const didUrl = `/api/me/didww/available-dids?did_group_id=${didGroup.id}`;
        
        const dr = await fetch(didUrl);
        const dj = await dr.json();
        availableDidsData = dj.data || [];
        
        const tbody = $('#available-dids-table tbody');
        tbody.innerHTML = '';
        
        if (availableDidsData.length === 0) {
          $('#available-dids-empty').textContent = 'No specific numbers available. You can buy a random number from this group.';
          // Add option to buy random
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="4">Random ${isTollfree ? 'toll-free ' : ''}number from ${escapeHtml(attrs.name || 'this group')}</td><td><button class="buy-did" data-random="true">Buy Random</button></td>`;
          tbody.appendChild(tr);
          $('#available-dids-table').style.display = 'table';
        } else {
          availableDidsData.forEach(did => {
            const da = did.attributes || {};
            const tr = document.createElement('tr');
            const rawType = da.did_type || da.didType || da.number_type || da.numberType || '';
            const typeLabel = isTollfree ? 'Toll-Free' : (rawType ? String(rawType) : 'Local');
            tr.innerHTML = `<td>${escapeHtml(da.number || '')}</td><td>${escapeHtml(typeLabel)}</td><td>$${markupMonthly.toFixed(2)}</td><td>$${markupSetup.toFixed(2)}</td><td><button class=\"buy-did\" data-id=\"${did.id}\">Buy</button></td>`;
            tbody.appendChild(tr);
          });
          $('#available-dids-table').style.display = 'table';
        }
      } catch (e) {
        console.error('[searchDids]', e);
        $('#did-groups-info').textContent = 'Search failed. Please try again.';
      }
    });

    // Buy DID
    document.addEventListener('click', async (ev) => {
      if (ev.target && ev.target.classList.contains('buy-did')) {
        const btn = ev.target;
        const isRandom = btn.getAttribute('data-random') === 'true';
        const availableDidId = btn.getAttribute('data-id');
        
        if (!currentSkuId) return alert('No SKU selected');
        if (!confirm('Purchase this number? You will be charged.')) return;
        
        btn.disabled = true;
        btn.textContent = 'Buying...';
        
        try {
          const isTollfree = $('#buyTollfree').checked;
          const payload = { sku_id: currentSkuId, is_tollfree: isTollfree };
          if (isRandom) payload.did_group_id = currentDidGroupId;
          else payload.available_did_id = availableDidId;
          
          const r = await fetch('/api/me/didww/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const j = await r.json();
          if (!j.success) {
            btn.disabled = false;
            btn.textContent = 'Buy';
            const msg = j.message || 'Purchase failed';
            if (/insufficient balance/i.test(msg)) {
              // Show a cleaner message and surface the Add Funds modal
              showToast(msg, 'error');
              if (document.getElementById('addFundModal')) {
                document.getElementById('addFundModal').style.display = 'flex';
                if (document.getElementById('fundAmount')) {
                  document.getElementById('fundAmount').focus();
                }
              }
              return;
            }
            return alert(msg);
          }
          showToast('Number purchased successfully!');
          // Refresh search
          $('#searchDids').click();
        } catch (e) {
          console.error('[buyDid]', e);
          btn.disabled = false;
          btn.textContent = 'Buy';
          alert('Purchase failed');
        }
      }
    });

    // ========== My Numbers ==========
    let allTrunks = []; // Cache voice trunks for dropdown
    let allMyDids = []; // Cache all DIDs for pagination
    let myDidsIncluded = []; // Cache included data
    let mydidsPage = 0; const mydidsPageSize = 10;
    let mydidsSearchQuery = '';
    
    // My Numbers search handlers
    $('#mydidsSearchBtn').addEventListener('click', () => {
      mydidsSearchQuery = $('#mydidsSearch').value.trim();
      mydidsPage = 0;
      renderMyDidsPage();
    });
    
    $('#mydidsClearBtn').addEventListener('click', () => {
      mydidsSearchQuery = '';
      $('#mydidsSearch').value = '';
      mydidsPage = 0;
      renderMyDidsPage();
    });
    
    $('#mydidsSearch').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        mydidsSearchQuery = $('#mydidsSearch').value.trim();
        mydidsPage = 0;
        renderMyDidsPage();
      }
    });
    
    async function loadMyDids() {
      try {
        // Fetch DIDs and voice trunks in parallel
        const [didsRes, trunksRes] = await Promise.all([
          fetch('/api/me/didww/dids'),
          fetch('/api/me/didww/trunks')
        ]);
        const didsJson = await didsRes.json();
        const trunksJson = await trunksRes.json();
        
        if (!didsJson.success) {
          $('#mydids-empty').textContent = didsJson.message || 'Failed to load numbers';
          return;
        }
        
        allMyDids = didsJson.data || [];
        myDidsIncluded = didsJson.included || [];
        const included = myDidsIncluded;
        allTrunks = trunksJson.data || [];
        
        // Build lookups from included data
        const trunksMap = {};
        const citiesMap = {};
        const regionsMap = {};
        const countriesMap = {};
        const didGroupsMap = {};
        const skusMap = {};
        
        included.forEach(item => {
          if (item.type === 'voice_in_trunks') trunksMap[item.id] = item.attributes?.name || item.id;
          if (item.type === 'cities') citiesMap[item.id] = item.attributes?.name || '';
          if (item.type === 'regions') regionsMap[item.id] = item.attributes?.name || '';
          if (item.type === 'countries') countriesMap[item.id] = item.attributes?.name || '';
          if (item.type === 'did_groups') didGroupsMap[item.id] = item;
          if (item.type === 'stock_keeping_units') skusMap[item.id] = item.attributes || {};
        });
        
        // Also add from trunks API response
        allTrunks.forEach(t => {
          trunksMap[t.id] = t.attributes?.name || t.id;
        });
        
        const tbody = $('#mydids-table tbody');
        tbody.innerHTML = '';
        
        // Paginate
        const start = mydidsPage * mydidsPageSize;
        const paginated = allMyDids.slice(start, start + mydidsPageSize);
        const totalPages = Math.ceil(allMyDids.length / mydidsPageSize);
        
        if (allMyDids.length === 0) {
          $('#mydids-empty').textContent = 'No numbers yet. Go to "Buy Numbers" to purchase.';
          $('#mydids-empty').style.display = 'block';
          $('#mydids-table').style.display = 'none';
          $('#mydids-pager').style.display = 'none';
        } else {
          $('#mydids-empty').style.display = 'none';
          $('#mydids-table').style.display = 'table';
          $('#mydids-pager').style.display = 'flex';
          $('#mydidsPageInfo').textContent = `Page ${mydidsPage + 1} of ${totalPages}`;
          paginated.forEach(did => {
            const attrs = did.attributes || {};
            const trunkRel = did.relationships?.voice_in_trunk?.data;
            const currentTrunkId = trunkRel?.id || '';
            
            // Build location from did_group relationships or attributes
            let location = '';
            const didGroupRel = did.relationships?.did_group?.data;
            if (didGroupRel) {
              const dg = didGroupsMap[didGroupRel.id];
              if (dg) {
                const cityRel = dg.relationships?.city?.data;
                const regionRel = dg.relationships?.region?.data;
                const countryRel = dg.relationships?.country?.data;
                const parts = [];
                if (cityRel && citiesMap[cityRel.id]) parts.push(citiesMap[cityRel.id]);
                if (regionRel && regionsMap[regionRel.id]) parts.push(regionsMap[regionRel.id]);
                if (countryRel && countriesMap[countryRel.id]) parts.push(countriesMap[countryRel.id]);
                location = parts.join(', ');
              }
            }
            // Fallback to attributes if available
            if (!location) {
              location = [attrs.city_name, attrs.region_name, attrs.country_name].filter(Boolean).join(', ');
            }
            
            // Determine if this DID is toll-free for pricing
            const didType = String(attrs.did_type || '').toLowerCase();
            let isTollfreeDid = didType.includes('toll');
            if (!isTollfreeDid && didGroupRel) {
              const dg = didGroupsMap[didGroupRel.id];
              if (dg) {
                const name = String(dg.attributes?.name || '').toLowerCase();
                if (name.includes('toll')) isTollfreeDid = true;
              }
            }
            // Fallback: detect US/CA toll-free by prefix (800, 833, 844, 855, 866, 877, 888)
            if (!isTollfreeDid) {
              const rawNum = String(attrs.number || '').replace(/\D/g, '');
              if (rawNum) {
                const digits = rawNum.length > 11 ? rawNum.slice(-11) : rawNum;
                const npa = digits.startsWith('1') ? digits.slice(1,4) : digits.slice(0,3);
                const tollfreeNpas = ['800','833','844','855','866','877','888'];
                if (tollfreeNpas.includes(npa)) isTollfreeDid = true;
              }
            }
            
            // Use fixed markup prices instead of raw DIDWW prices
            const monthlyPrice = (isTollfreeDid ? TOLLFREE_DID_MARKUP : LOCAL_DID_MARKUP).toFixed(2);
            
            // Calculate status/time left
            let statusHtml = '';
            const billedTo = attrs.billing?.billed_to || attrs.expires_at;
            if (billedTo) {
              const expDate = new Date(billedTo);
              const now = new Date();
              const daysLeft = Math.ceil((expDate - now) / (1000 * 60 * 60 * 24));
              const statusColor = daysLeft > 7 ? '#22c55e' : (daysLeft > 0 ? '#f59e0b' : '#ef4444');
              statusHtml = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${statusColor};margin-right:6px"></span>${daysLeft > 0 ? daysLeft + ' days' : 'Expired'}`;
            } else {
              statusHtml = '<span class="muted">-</span>';
            }
            
            // Build features icons
            let featuresHtml = '';
            const features = attrs.features || attrs.capabilities || {};
            // Check various feature flags
            if (features.voice || attrs.voice_in_enabled !== false) featuresHtml += '<span title="Voice" style="background:#22c55e;color:#fff;padding:2px 6px;border-radius:4px;margin:1px;font-size:11px">üìû</span>';
            if (features.sms || attrs.sms_in_enabled) featuresHtml += '<span title="SMS" style="background:#22c55e;color:#fff;padding:2px 6px;border-radius:4px;margin:1px;font-size:11px">üí¨</span>';
            if (features.fax || attrs.fax_in_enabled) featuresHtml += '<span title="Fax" style="background:#22c55e;color:#fff;padding:2px 6px;border-radius:4px;margin:1px;font-size:11px">üì†</span>';
            if (!featuresHtml) featuresHtml = '<span title="Voice" style="background:#22c55e;color:#fff;padding:2px 6px;border-radius:4px;margin:1px;font-size:11px">üìû</span>';
            
            // Build trunk dropdown options
            let trunkOptions = '<option value="">-- None --</option>';
            allTrunks.forEach(t => {
              const tName = t.attributes?.name || t.id;
              const selected = t.id === currentTrunkId ? 'selected' : '';
              trunkOptions += `<option value="${escapeHtml(t.id)}" ${selected}>${escapeHtml(tName)}</option>`;
            });
            
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(attrs.number || '')}</td>`+
                          `<td>${escapeHtml(location)}</td>`+
                          `<td>${statusHtml}</td>`+
                          `<td>${featuresHtml}</td>`+
                          `<td>$${monthlyPrice}</td>`+
                          `<td><select class="trunk-select" data-did-id="${escapeHtml(did.id)}" style="width:90px">${trunkOptions}</select></td>`+
                          `<td><button class="del-did" data-id="${escapeHtml(did.id)}">Release</button></td>`;
            tbody.appendChild(tr);
          });
        }
      } catch (e) {
        console.error('[loadMyDids]', e);
        $('#mydids-empty').textContent = 'Failed to load numbers';
        $('#mydids-pager').style.display = 'none';
      }
    }
    
    // My Numbers pagination
    document.getElementById('mydidsPrev').addEventListener('click', () => { if (mydidsPage > 0) { mydidsPage--; renderMyDidsPage(); } });
    document.getElementById('mydidsNext').addEventListener('click', () => { 
      const filteredDids = getFilteredMyDids();
      if ((mydidsPage + 1) * mydidsPageSize < filteredDids.length) { mydidsPage++; renderMyDidsPage(); } 
    });
    
    function getFilteredMyDids() {
      if (!mydidsSearchQuery) return allMyDids;
      const q = mydidsSearchQuery.toLowerCase();
      return allMyDids.filter(did => {
        const attrs = did.attributes || {};
        const number = (attrs.number || '').toLowerCase();
        const location = [attrs.city_name, attrs.region_name, attrs.country_name].filter(Boolean).join(', ').toLowerCase();
        return number.includes(q) || location.includes(q);
      });
    }
    
    function renderMyDidsPage() {
      const included = myDidsIncluded;
      const trunksMap = {};
      const citiesMap = {};
      const regionsMap = {};
      const countriesMap = {};
      const didGroupsMap = {};
      const skusMap = {};
      
      included.forEach(item => {
        if (item.type === 'voice_in_trunks') trunksMap[item.id] = item.attributes?.name || item.id;
        if (item.type === 'cities') citiesMap[item.id] = item.attributes?.name || '';
        if (item.type === 'regions') regionsMap[item.id] = item.attributes?.name || '';
        if (item.type === 'countries') countriesMap[item.id] = item.attributes?.name || '';
        if (item.type === 'did_groups') didGroupsMap[item.id] = item;
        if (item.type === 'stock_keeping_units') skusMap[item.id] = item.attributes || {};
      });
      allTrunks.forEach(t => { trunksMap[t.id] = t.attributes?.name || t.id; });
      
      // Apply search filter
      const filteredDids = getFilteredMyDids();
      
      const tbody = $('#mydids-table tbody');
      tbody.innerHTML = '';
      const start = mydidsPage * mydidsPageSize;
      const paginated = filteredDids.slice(start, start + mydidsPageSize);
      const totalPages = Math.ceil(filteredDids.length / mydidsPageSize) || 1;
      
      if (filteredDids.length === 0) {
        $('#mydids-empty').textContent = mydidsSearchQuery ? 'No numbers match your search' : 'No numbers yet. Go to "Buy Numbers" to purchase.';
        $('#mydids-empty').style.display = 'block';
        $('#mydids-table').style.display = 'none';
        $('#mydids-pager').style.display = 'none';
        return;
      }
      
      $('#mydids-empty').style.display = 'none';
      $('#mydids-table').style.display = 'table';
      $('#mydids-pager').style.display = 'flex';
      $('#mydidsPageInfo').textContent = mydidsSearchQuery ? `${filteredDids.length} result(s)` : `Page ${mydidsPage + 1} of ${totalPages}`;
      
      paginated.forEach(did => {
        const attrs = did.attributes || {};
        const trunkRel = did.relationships?.voice_in_trunk?.data;
        const currentTrunkId = trunkRel?.id || '';
        let location = '';
        const didGroupRel = did.relationships?.did_group?.data;
        if (didGroupRel) {
          const dg = didGroupsMap[didGroupRel.id];
          if (dg) {
            const parts = [];
            const cityRel = dg.relationships?.city?.data;
            const regionRel = dg.relationships?.region?.data;
            const countryRel = dg.relationships?.country?.data;
            if (cityRel && citiesMap[cityRel.id]) parts.push(citiesMap[cityRel.id]);
            if (regionRel && regionsMap[regionRel.id]) parts.push(regionsMap[regionRel.id]);
            if (countryRel && countriesMap[countryRel.id]) parts.push(countriesMap[countryRel.id]);
            location = parts.join(', ');
          }
        }
        if (!location) location = [attrs.city_name, attrs.region_name, attrs.country_name].filter(Boolean).join(', ');

        // Determine if this DID is toll-free for pricing
        const didType = String(attrs.did_type || '').toLowerCase();
        let isTollfreeDid = didType.includes('toll');
        if (!isTollfreeDid && didGroupRel) {
          const dg = didGroupsMap[didGroupRel.id];
          if (dg) {
            const name = String(dg.attributes?.name || '').toLowerCase();
            if (name.includes('toll')) isTollfreeDid = true;
          }
        }
        // Fallback: detect US/CA toll-free by prefix (800, 833, 844, 855, 866, 877, 888)
        if (!isTollfreeDid) {
          const rawNum = String(attrs.number || '').replace(/\D/g, '');
          if (rawNum) {
            const digits = rawNum.length > 11 ? rawNum.slice(-11) : rawNum;
            const npa = digits.startsWith('1') ? digits.slice(1,4) : digits.slice(0,3);
            const tollfreeNpas = ['800','833','844','855','866','877','888'];
            if (tollfreeNpas.includes(npa)) isTollfreeDid = true;
          }
        }

        const monthlyPrice = (isTollfreeDid ? TOLLFREE_DID_MARKUP : LOCAL_DID_MARKUP).toFixed(2);
        let statusHtml = '';
        const billedTo = attrs.billing?.billed_to || attrs.expires_at;
        if (billedTo) {
          const daysLeft = Math.ceil((new Date(billedTo) - new Date()) / (1000 * 60 * 60 * 24));
          const statusColor = daysLeft > 7 ? '#22c55e' : (daysLeft > 0 ? '#f59e0b' : '#ef4444');
          statusHtml = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${statusColor};margin-right:6px"></span>${daysLeft > 0 ? daysLeft + ' days' : 'Expired'}`;
        } else { statusHtml = '<span class="muted">-</span>'; }
        let featuresHtml = '<span title="Voice" style="background:#22c55e;color:#fff;padding:2px 6px;border-radius:4px;margin:1px;font-size:11px">üìû</span>';
        if (attrs.sms_in_enabled) featuresHtml += '<span title="SMS" style="background:#22c55e;color:#fff;padding:2px 6px;border-radius:4px;margin:1px;font-size:11px">üí¨</span>';
        if (attrs.fax_in_enabled) featuresHtml += '<span title="Fax" style="background:#22c55e;color:#fff;padding:2px 6px;border-radius:4px;margin:1px;font-size:11px">üì†</span>';
        let trunkOptions = '<option value="">-- None --</option>';
        allTrunks.forEach(t => {
          const selected = t.id === currentTrunkId ? 'selected' : '';
          trunkOptions += `<option value="${escapeHtml(t.id)}" ${selected}>${escapeHtml(t.attributes?.name || t.id)}</option>`;
        });
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(attrs.number || '')}</td><td>${escapeHtml(location)}</td><td>${statusHtml}</td><td>${featuresHtml}</td><td>$${monthlyPrice}</td><td><select class=\"trunk-select\" data-did-id=\"${escapeHtml(did.id)}\" style=\"width:90px\">${trunkOptions}</select></td><td><button class=\"del-did\" data-id=\"${escapeHtml(did.id)}\">Release</button></td>`;
        tbody.appendChild(tr);
      });
    }

    // Update voice trunk assignment
    document.addEventListener('change', async (ev) => {
      if (ev.target && ev.target.classList.contains('trunk-select')) {
        const select = ev.target;
        const didId = select.getAttribute('data-did-id');
        const trunkId = select.value;
        
        select.disabled = true;
        try {
          const r = await fetch(`/api/me/didww/dids/${encodeURIComponent(didId)}/trunk`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ trunk_id: trunkId || null })
          });
          const j = await r.json();
          if (!j.success) {
            alert(j.message || 'Failed to update trunk');
            loadMyDids();
            return;
          }
          showToast('Call forwarding updated!');
        } catch (e) {
          console.error('[updateTrunk]', e);
          alert('Failed to update trunk');
          loadMyDids();
        } finally {
          select.disabled = false;
        }
      }
    });

    // Delete DID
    document.addEventListener('click', async (ev) => {
      if (ev.target && ev.target.classList.contains('del-did')) {
        const id = ev.target.getAttribute('data-id');
        if (!confirm('Release this number? This action cannot be undone.')) return;
        try {
          const r = await fetch(`/api/me/didww/dids/${encodeURIComponent(id)}`, { method: 'DELETE' });
          const j = await r.json();
          if (!j.success) return alert(j.message || 'Release failed');
          showToast('Number released successfully!');
          loadMyDids();
        } catch (e) {
          console.error('[deleteDid]', e);
          alert('Failed to release number');
        }
      }
    });
  </script>
<!-- Start of LiveChat (www.livechat.com) code -->
<script>
    window.__lc = window.__lc || {};
    window.__lc.license = 18919976;
    window.__lc.integration_name = "manual_channels";
    window.__lc.product_name = "livechat";
    ;(function(n,t,c){function i(n){return e._h?e._h.apply(null,n):e._q.push(n)}var e={_q:[],_h:null,_v:"2.0",on:function(){i(["on",c.call(arguments)])},once:function(){i(["once",c.call(arguments)])},off:function(){i(["off",c.call(arguments)])},get:function(){if(!e._h)throw new Error("[LiveChatWidget] You can't use getters before load.");return i(["get",c.call(arguments)])},call:function(){i(["call",c.call(arguments)])},init:function(){var n=t.createElement("script");n.async=!0,n.type="text/javascript",n.src="https://cdn.livechatinc.com/tracking.js",t.head.appendChild(n)}};!n.__lc.asyncInit&&e.init(),n.LiveChatWidget=n.LiveChatWidget||e}(window,document,[].slice))
</script>
<noscript><a href="https://www.livechat.com/chat-with/18919976/" rel="nofollow">Chat with us</a>, powered by <a href="https://www.livechat.com/?welcome" rel="noopener nofollow" target="_blank">LiveChat</a></noscript>
<!-- End of LiveChat code -->

</body>
</html>
